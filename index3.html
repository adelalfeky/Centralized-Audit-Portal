<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Portal - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-in-progress { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-overdue { background-color: #fee2e2; color: #991b1b; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .highlight-row { background-color: #f0f9ff; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .hidden { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100 p-4 fade-in">
        <div class="w-full max-w-md">
            <div class="bg-white card-shadow rounded-xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white text-center">
                    <i class="fas fa-clipboard-check text-4xl mb-4"></i>
                    <h1 class="text-2xl font-bold">Centralized Audit Portal</h1>
                    <p class="opacity-90 mt-2">Tasheer - Entity-wide Diagnostic Assessment</p>
                </div>
                
                <div class="p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Sign In to Your Account</h2>
                    
                    <form id="login-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="username">Username</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-user text-gray-400"></i>
                                </div>
                                <input type="text" id="username" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your username" required>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Password</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input type="password" id="password" class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your password" required>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <button type="button" id="toggle-password" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="remember-me" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-700">Remember me</label>
                            </div>
                            <button type="button" id="forgot-password" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Forgot password?</button>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                        </button>
                    </form>
                    
                    <div id="login-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                        <i class="fas fa-exclamation-circle mr-2"></i> <span id="error-message">Invalid username or password</span>
                    </div>
                    
                    <div class="mt-6">
                        <p class="text-gray-600 text-sm mb-2 text-center font-medium">Demo Access Credentials:</p>
                        <div class="bg-gray-50 p-3 rounded-lg text-xs">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="font-medium">Admin:</div>
                                <div>admin / admin123</div>
                                <div class="font-medium">Corporate IT:</div>
                                <div>corpit / corpit123</div>
                                <div class="font-medium">Data Analytics:</div>
                                <div>dataanalytics / data123</div>
                                <div class="font-medium">Infrastructure:</div>
                                <div>infrastructure / infra123</div>
                                <div class="font-medium">Platforms:</div>
                                <div>platforms / platform123</div>
                                <div class="font-medium">Quality Assurance:</div>
                                <div>qualityassurance / quality123</div>
                                <div class="font-medium">Solution Dev:</div>
                                <div>solutiondev / solution123</div>
                                <div class="font-medium">Tech Strategy:</div>
                                <div>techstrategy / strategy123</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center text-gray-600 text-sm">
                <p>&copy; 2026 Tasheer Audit Portal. For authorized personnel only.</p>
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden until login) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <div class="bg-blue-600 text-white p-3 rounded-lg">
                            <i class="fas fa-clipboard-check text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Centralized Audit Requirement Portal</h1>
                            <p class="text-gray-600" id="company-name">Tasheer - Entity-wide Diagnostic Assessment Review</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:block text-right">
                            <p class="font-medium text-gray-800" id="user-greeting">Welcome, Admin</p>
                            <p class="text-sm text-gray-600" id="user-role">Administrator</p>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 rounded-lg px-4 py-2 transition duration-200">
                                <div class="bg-blue-600 text-white h-8 w-8 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="hidden md:block">
                                    <p class="text-sm font-medium text-gray-800 truncate max-w-[120px]" id="username-display">Admin</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-600 text-xs"></i>
                            </button>
                            
                            <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
                                <div class="p-4 border-b border-gray-200">
                                    <p class="font-medium text-gray-800 truncate" id="menu-username">Admin</p>
                                    <p class="text-sm text-gray-600 truncate" id="menu-role">Administrator</p>
                                </div>
                                <div class="py-1">
                                    <a href="#" id="profile-btn" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-user-circle mr-3 text-gray-500"></i> My Profile
                                    </a>
                                    <a href="#" id="change-password-btn" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-key mr-3 text-gray-500"></i> Change Password
                                    </a>
                                    <div class="border-t border-gray-200 my-1"></div>
                                    <a href="#" id="logout-btn" class="flex items-center px-4 py-2 text-red-600 hover:bg-gray-100">
                                        <i class="fas fa-sign-out-alt mr-3"></i> Logout
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <div class="container mx-auto px-4 py-6" id="main-content">
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Administrator Dashboard</h2>
                        <p class="text-gray-600">Manage users, departments, and system settings</p>
                    </div>
                    
                    <div class="mt-4 md:mt-0 flex flex-wrap gap-3">
                        <button id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-user-plus mr-2"></i> Add New User
                        </button>
                        <button id="refresh-data-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                        </button>
                    </div>
                </div>
                
                <!-- Admin Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Total Users</p>
                                <p class="text-3xl font-bold text-gray-800" id="total-users">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Department Directors</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-count">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-user-tie text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Pending Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="admin-pending-reqs">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Completed Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="admin-completed-reqs">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Management -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">User Management</h3>
                        
                        <div class="mt-3 md:mt-0">
                            <div class="relative">
                                <input type="text" id="user-search" class="border border-gray-300 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-64" placeholder="Search users...">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-200 text-center text-gray-600 text-sm">
                        <p>Showing <span id="users-count">0</span> users</p>
                    </div>
                </div>
                
                <!-- Department Overview -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Department Status Overview</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Requirements</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">In Progress</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% Complete</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dept-status-table" class="bg-white divide-y divide-gray-200">
                                <!-- Department status will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Director Dashboard -->
            <div id="director-dashboard" class="hidden">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Total Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-total-reqs">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-list-check text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Pending</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-pending-reqs">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">In Progress</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-progress-reqs">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-spinner text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Completed</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-completed-reqs">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Department Header -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="director-dept-title">Department Requirements</h3>
                            <p class="text-gray-600" id="director-dept-subtitle">Request Date: 02 Feb 2026 | Deadline: 28 Feb 2026</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0 flex flex-wrap gap-3">
                            <div class="relative">
                                <select id="director-status-filter" class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-filter"></i>
                                </div>
                            </div>
                            
                            <button id="director-export-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-download mr-2"></i> Export
                            </button>
                            
                            <button id="director-submit-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-paper-plane mr-2"></i> Submit All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Requirements Table -->
                    <div class="overflow-x-auto max-h-[500px] scrollbar-hide">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sr. No.</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Information Requested</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="director-requirements-table" class="bg-white divide-y divide-gray-200">
                                <!-- Requirements will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing <span id="director-start-item">1</span> to <span id="director-end-item">10</span> of <span id="director-total-items">0</span> requirements
                        </div>
                        <div class="flex space-x-2">
                            <button id="director-prev-page" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="director-next-page" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white card-shadow rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Progress Summary</h4>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Overall Completion</span>
                                <span id="completion-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="completion-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">Pending</span>
                                <span class="font-medium" id="summary-pending">0</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-blue-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">In Progress</span>
                                <span class="font-medium" id="summary-in-progress">0</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">Completed</span>
                                <span class="font-medium" id="summary-completed">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Recent Activity</h4>
                        <div id="activity-feed" class="space-y-4 max-h-60 overflow-y-auto scrollbar-hide p-1">
                            <!-- Activity items will be loaded here -->
                            <div class="text-gray-500 italic text-sm">No recent activity to display</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modals -->
        <!-- Update Requirement Modal (for directors) -->
        <div id="update-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white slide-in">
                <!-- Modal content same as previous version -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="modal-title">Update Requirement Status</h3>
                    <button id="close-update-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-1" id="requirement-title">Requirement Title</h4>
                        <p class="text-blue-700 text-sm" id="requirement-detail">Department - Requirement #1</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Status</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button data-status="pending" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-yellow-500 bg-white">
                                <div class="status-pending rounded-full p-2 mb-2">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <span class="text-sm font-medium">Pending</span>
                            </button>
                            <button data-status="in-progress" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-blue-500 bg-white">
                                <div class="status-in-progress rounded-full p-2 mb-2">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <span class="text-sm font-medium">In Progress</span>
                            </button>
                            <button data-status="completed" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-green-500 bg-white">
                                <div class="status-completed rounded-full p-2 mb-2">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <span class="text-sm font-medium">Completed</span>
                            </button>
                            <button data-status="overdue" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-red-500 bg-white">
                                <div class="status-overdue rounded-full p-2 mb-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <span class="text-sm font-medium">Overdue</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="receiving-date" class="block text-gray-700 text-sm font-medium mb-2">Receiving Date</label>
                        <input type="date" id="receiving-date" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="mb-6">
                        <label for="remarks" class="block text-gray-700 text-sm font-medium mb-2">Remarks/Notes</label>
                        <textarea id="remarks" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Add any comments or notes about this requirement..."></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Upload Supporting Document (Optional)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">Drag & drop files here or</p>
                            <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg inline-block">
                                <i class="fas fa-upload mr-2"></i> Browse Files
                            </label>
                            <input type="file" id="file-upload" class="hidden" multiple>
                            <p class="text-gray-500 text-xs mt-3">Maximum file size: 10MB. Supported formats: PDF, DOC, XLS, JPG, PNG</p>
                        </div>
                        <div id="file-list" class="mt-3 space-y-2"></div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-update-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="save-status-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save Changes</button>
                    <button id="submit-status-btn" class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                        <i class="fas fa-paper-plane mr-2"></i> Submit
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit User Modal (for admin) -->
        <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="user-modal-title">Add New User</h3>
                    <button id="close-user-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <form id="user-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-username">Username *</label>
                            <input type="text" id="user-username" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., johndoe" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-password">Password *</label>
                            <input type="password" id="user-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimum 6 characters" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-fullname">Full Name *</label>
                            <input type="text" id="user-fullname" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., John Doe" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-email">Email Address</label>
                            <input type="email" id="user-email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., john.doe@tasheer.com">
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-role">Role *</label>
                            <select id="user-role" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select Role</option>
                                <option value="admin">Administrator</option>
                                <option value="director">Department Director</option>
                                <option value="viewer">Viewer (Read-only)</option>
                            </select>
                        </div>
                        
                        <div class="mb-5 hidden" id="department-select-container">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-department">Department *</label>
                            <select id="user-department" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Department</option>
                                <option value="corporate-it">Corporate IT</option>
                                <option value="data-analytics">Data Analytics & Business Intelligence</option>
                                <option value="infrastructure">Infrastructure & Operations</option>
                                <option value="platforms">Platforms and IT Solution Operations</option>
                                <option value="quality-assurance">Quality Assurance</option>
                                <option value="solution-dev">Solution Development & Delivery</option>
                                <option value="tech-strategy">Tech Strategy & Enterprise Architecture</option>
                            </select>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-status">Status</label>
                            <select id="user-status" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending Activation</option>
                            </select>
                        </div>
                        
                        <input type="hidden" id="editing-user-id" value="">
                    </form>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-user-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="reset-password-btn" class="px-5 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium hidden">Reset Password</button>
                    <button id="save-user-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save User</button>
                </div>
            </div>
        </div>
        
        <!-- Change Password Modal -->
        <div id="change-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Change Password</h3>
                    <button id="close-password-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <form id="change-password-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="current-password">Current Password *</label>
                            <input type="password" id="current-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="new-password">New Password *</label>
                            <input type="password" id="new-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="confirm-password">Confirm New Password *</label>
                            <input type="password" id="confirm-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div id="password-error" class="mb-5 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                            <i class="fas fa-exclamation-circle mr-2"></i> <span id="password-error-message">Passwords do not match</span>
                        </div>
                    </form>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-password-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="save-password-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Change Password</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Toast -->
        <div id="confirmation-toast" class="fixed bottom-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg hidden z-50 slide-in">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-xl mr-3"></i>
                <div>
                    <p class="font-medium">Operation completed successfully!</p>
                    <p class="text-sm opacity-90">Your changes have been saved.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const appState = {
            currentUser: null,
            users: [],
            departments: [],
            requirements: [],
            filteredRequirements: [],
            currentPage: 1,
            itemsPerPage: 10,
            currentRequirementId: null,
            editingUserId: null,
            activities: []
        };

        // Initialize default data
        function initializeData() {
            // Initialize departments data
            const departmentsData = [
                {
                    id: 'corporate-it',
                    name: 'Corporate IT',
                    requirements: [
                        { id: 1, description: 'Approved Org structure', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved Strategy', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'IT Enterprise Architecture document', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'IT budget for 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'IT service catalogue', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Service Level Agreements between IT and business departments', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'List of IT projects in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'IT performance report (servers utilization, UPS, capacity reports)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'IT asset register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'Current Network Topology and Diagram', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 23, description: 'List of Network devices and their details', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 24, description: 'Multi-Factor Authentication (MFA) Configuration', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 25, description: 'Password Storage Encryption Details', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 26, description: 'Password setting on Domain Controller', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 27, description: 'Access Workflow approvals', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 28, description: 'User Access Review Document', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 29, description: 'Business Continuity and Disaster Recovery policy, procedure, and plans', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 30, description: 'Test plans and reports for Business Continuity and Disaster Recovery', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 31, description: 'Latest Business Impact Analysis (BIA) report', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 32, description: 'IT Risk Management Framework', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 33, description: 'IT Risk Register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 34, description: 'Approved Job description for IT staff from HR', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 35, description: 'IT succession plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 36, description: 'List of Trainings planned/provided for IT staff', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 37, description: 'Records of training needs assessments', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 38, description: 'Email notification for training', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 39, description: 'IT approved vendors list', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 40, description: 'IT vendors contracts', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 41, description: 'Technology Maturity Assessment Reports', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'data-analytics',
                    name: 'Data Analytics & Business Intelligence',
                    requirements: [
                        { id: 1, description: 'Data governance policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Approved Data Analytics & Business Intelligence framework and operating model', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Defined roles and responsibilities (data owners, data stewards, BI developers)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'Documented data architecture (source systems, data warehouse, data marts)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Data integration and ETL processes documentation', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'List of all data sources feeding BI solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'Data lineage and dependency mapping', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'Data quality framework and standards', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'Data quality rules, thresholds, and monitoring reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'Issue logs for data quality defects and remediation actions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 23, description: 'List of all BI dashboards and analytical reports produced during FY2024-FY2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 24, description: 'List of analytical models (predictive, prescriptive) used', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'infrastructure',
                    name: 'Infrastructure & Operations',
                    requirements: [
                        { id: 1, description: 'Approved org structure', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Approved IT performance metrics', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'IT performance report (servers utilization, UPS, capacity reports)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Monitoring tools for infrastructure availability and performance', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Samples of IT performance reports / emails', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'List of backup performed in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'List of backup restoration process performed in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'IT asset register of all infrastructure assets, including hardware, software, and licenses', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'List of Network devices and their details', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 23, description: 'Current Network Topology and Diagram', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 24, description: 'List of available Database and Operating Systems, servers, admins, versions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 25, description: 'List of incident tickets raised in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 26, description: 'Incident classification and categorization methodology', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 27, description: 'Problems logged for recurring incidents (problem management)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 28, description: 'Reports prepared and published to management on service requests', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 29, description: 'Change Advisory Board Charter', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 30, description: 'List of changes (System generated) in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 31, description: 'List of changes (Manual list) in 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 32, description: 'Network change management logs / tickets', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 33, description: 'Security controls implemented at the infrastructure level, including hardening standards and access controls', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 34, description: 'Identity and privileged access management for infrastructure components', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 35, description: 'Logging, monitoring, and centralized log management for infrastructure activities', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'platforms',
                    name: 'Platforms and IT Solution Operations',
                    requirements: [
                        { id: 1, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved platform and solution strategy aligned with business objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Defined ownership for each platform and IT solution, including business and technical owners', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Documentation and knowledge transfer for platforms and IT solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'Complete inventory of all platforms and IT solutions, including purpose, criticality, and users', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Classification of platforms and IT solutions based on business criticality and data sensitivity', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Defined lifecycle management process for platforms and IT solutions, including development, maintenance, and deactivation', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'Segregation of environments and access controls between environments', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'Data protection controls, including encryption, masking, and secure data handling', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'Application and platform logging, monitoring, and alerting mechanisms', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'Performance monitoring and capacity management for platforms and IT solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 23, description: 'Patch and vulnerability management for platforms, middleware, and application components', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 24, description: 'Regular security testing (e.g., VA/PT, code scanning)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 25, description: 'Backup and recovery processes for platforms and application data', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 26, description: 'Disaster recovery and business continuity plans covering platforms and IT solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 27, description: 'Defined SLAs and support agreements for platforms and IT solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'quality-assurance',
                    name: 'Quality Assurance',
                    requirements: [
                        { id: 1, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Defined test environments and readiness criteria', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Functional testing processes to validate business and system requirements', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'Test execution tracking and reporting mechanisms', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Formal go-live readiness and release quality assessment during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Validation of fixes and re-testing evidence during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'Independent QA reviews and quality audits over IT systems and solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'Post-implementation reviews to assess quality outcomes', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'solution-dev',
                    name: 'Solution Development & Delivery',
                    requirements: [
                        { id: 1, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Defined prioritization and approval mechanisms for development initiatives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Documented business case and requirements approval process', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'Documented software development lifecycle (SDLC) methodology (e.g., Agile, Waterfall, Hybrid)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Configuration and release management for solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Go-live readiness assessment and formal approval during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'Knowledge transfer to operations and support teams during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'Application security testing and vulnerability remediation during development during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'Vendor and third-party management for outsourced or packaged solutions', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'SLA and support model definition prior to solution deployment', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                },
                {
                    id: 'tech-strategy',
                    name: 'Tech Strategy & Enterprise Architecture',
                    requirements: [
                        { id: 1, description: 'Approved policies and procedures', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 2, description: 'Approved functional statement defining the department\'s roles and responsibilities', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 3, description: 'Approved department objectives aligned with the company\'s strategic objectives', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 4, description: 'Approved list of key performance indicators (KPIs) and performance metrics used by the department', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 5, description: 'Approved Job Descriptions (JDs) for department employees', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 6, description: 'Department risk register', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 7, description: 'List of all reports generated by the department (including report type, purpose, frequency, and target audience), with samples of those reports', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 8, description: 'Approved department annual plan / work plan', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 9, description: 'Latest Internal Audit reports relevant to the department and other reports from other assurance providers, if applicable', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 10, description: 'List of external stakeholders, regulators, and oversight bodies the department interacts with', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 11, description: 'List of applicable laws, regulations, and other mandatory compliance obligations monitored by the department in relation to its operations', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 12, description: 'Approved Delegation of Authority (DoA) and/or RACI matrix applicable to the department (if available)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 13, description: 'Approved organizational structure of the department (showing reporting lines)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 14, description: 'Formal architecture decision-making and escalation mechanisms during 2025, if any', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 15, description: 'Documented current-state architecture across business, application, data, and technology layers', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 16, description: 'Defined current and target state architecture', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 17, description: 'Gap analysis between current and target architecture states', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 18, description: 'Standardized enterprise architecture framework and methodology (e.g., TOGAF or equivalent)', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 19, description: 'Approved architecture standards, principles, and design patterns', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 20, description: 'Integration of EA reviews within solution development and delivery lifecycle during 2025', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 21, description: 'Performance, scalability, resilience, and availability considerations in architecture design', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 22, description: 'Security-by-design and privacy-by-design principles embedded in architecture', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 23, description: 'Architecture documentation management and repository usage', requestDate: '2026-02-02', status: 'pending', remarks: '' },
                        { id: 24, description: 'Regular review and update of technology strategy and enterprise architecture artifacts', requestDate: '2026-02-02', status: 'pending', remarks: '' }
                    ]
                }
            ];

            // Initialize users if not exists
            if (!localStorage.getItem('auditPortalUsers')) {
                const defaultUsers = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        fullName: 'System Administrator',
                        email: 'admin@tasheer.com',
                        role: 'admin',
                        department: null,
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        username: 'corpit',
                        password: 'corpit123',
                        fullName: 'Corporate IT Director',
                        email: 'it.director@tasheer.com',
                        role: 'director',
                        department: 'corporate-it',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        username: 'dataanalytics',
                        password: 'data123',
                        fullName: 'Data Analytics Director',
                        email: 'data.director@tasheer.com',
                        role: 'director',
                        department: 'data-analytics',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 4,
                        username: 'infrastructure',
                        password: 'infra123',
                        fullName: 'Infrastructure Director',
                        email: 'infra.director@tasheer.com',
                        role: 'director',
                        department: 'infrastructure',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 5,
                        username: 'platforms',
                        password: 'platform123',
                        fullName: 'Platforms Director',
                        email: 'platforms.director@tasheer.com',
                        role: 'director',
                        department: 'platforms',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 6,
                        username: 'qualityassurance',
                        password: 'quality123',
                        fullName: 'Quality Assurance Director',
                        email: 'qa.director@tasheer.com',
                        role: 'director',
                        department: 'quality-assurance',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 7,
                        username: 'solutiondev',
                        password: 'solution123',
                        fullName: 'Solution Development Director',
                        email: 'solution.director@tasheer.com',
                        role: 'director',
                        department: 'solution-dev',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 8,
                        username: 'techstrategy',
                        password: 'strategy123',
                        fullName: 'Tech Strategy Director',
                        email: 'strategy.director@tasheer.com',
                        role: 'director',
                        department: 'tech-strategy',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('auditPortalUsers', JSON.stringify(defaultUsers));
            }

            // Load saved departments data or initialize
            if (!localStorage.getItem('auditPortalDepartments')) {
                localStorage.setItem('auditPortalDepartments', JSON.stringify(departmentsData));
            }

            // Load activities if exists
            if (!localStorage.getItem('auditPortalActivities')) {
                localStorage.setItem('auditPortalActivities', JSON.stringify([]));
            }

            // Load data into app state
            appState.users = JSON.parse(localStorage.getItem('auditPortalUsers'));
            appState.departments = JSON.parse(localStorage.getItem('auditPortalDepartments'));
            appState.activities = JSON.parse(localStorage.getItem('auditPortalActivities'));
        }

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const errorMessage = document.getElementById('error-message');
        
        const adminDashboard = document.getElementById('admin-dashboard');
        const directorDashboard = document.getElementById('director-dashboard');
        
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        
        const totalUsersEl = document.getElementById('total-users');
        const directorCountEl = document.getElementById('director-count');
        const adminPendingReqsEl = document.getElementById('admin-pending-reqs');
        const adminCompletedReqsEl = document.getElementById('admin-completed-reqs');
        const usersTable = document.getElementById('users-table');
        const deptStatusTable = document.getElementById('dept-status-table');
        const addUserBtn = document.getElementById('add-user-btn');
        
        const directorDeptTitle = document.getElementById('director-dept-title');
        const directorDeptSubtitle = document.getElementById('director-dept-subtitle');
        const directorTotalReqsEl = document.getElementById('director-total-reqs');
        const directorPendingReqsEl = document.getElementById('director-pending-reqs');
        const directorProgressReqsEl = document.getElementById('director-progress-reqs');
        const directorCompletedReqsEl = document.getElementById('director-completed-reqs');
        const directorRequirementsTable = document.getElementById('director-requirements-table');
        const directorStatusFilter = document.getElementById('director-status-filter');
        const directorExportBtn = document.getElementById('director-export-btn');
        const directorSubmitAllBtn = document.getElementById('director-submit-all-btn');
        const directorPrevPageBtn = document.getElementById('director-prev-page');
        const directorNextPageBtn = document.getElementById('director-next-page');
        const directorStartItemEl = document.getElementById('director-start-item');
        const directorEndItemEl = document.getElementById('director-end-item');
        const directorTotalItemsEl = document.getElementById('director-total-items');
        
        const updateModal = document.getElementById('update-modal');
        const closeUpdateModalBtn = document.getElementById('close-update-modal');
        const cancelUpdateModalBtn = document.getElementById('cancel-update-modal');
        const saveStatusBtn = document.getElementById('save-status-btn');
        const submitStatusBtn = document.getElementById('submit-status-btn');
        
        const userModal = document.getElementById('user-modal');
        const closeUserModalBtn = document.getElementById('close-user-modal');
        const cancelUserModalBtn = document.getElementById('cancel-user-modal');
        const saveUserBtn = document.getElementById('save-user-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        
        const changePasswordModal = document.getElementById('change-password-modal');
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const cancelPasswordModalBtn = document.getElementById('cancel-password-modal');
        const savePasswordBtn = document.getElementById('save-password-btn');
        
        const confirmationToast = document.getElementById('confirmation-toast');
        const activityFeed = document.getElementById('activity-feed');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            setupEventListeners();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    appState.currentUser = JSON.parse(savedUser);
                    showApp();
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);
            togglePasswordBtn.addEventListener('click', togglePasswordVisibility);
            
            // User menu
            userMenuBtn.addEventListener('click', toggleUserMenu);
            logoutBtn.addEventListener('click', handleLogout);
            changePasswordBtn.addEventListener('click', showChangePasswordModal);
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === updateModal) closeUpdateModal();
                if (event.target === userModal) closeUserModal();
                if (event.target === changePasswordModal) closePasswordModal();
                
                // Close user menu if clicking outside
                if (!event.target.closest('#user-menu-btn') && !event.target.closest('#user-menu')) {
                    userMenu.classList.add('hidden');
                }
            });
            
            // Modals
            closeUpdateModalBtn.addEventListener('click', closeUpdateModal);
            cancelUpdateModalBtn.addEventListener('click', closeUpdateModal);
            closeUserModalBtn.addEventListener('click', closeUserModal);
            cancelUserModalBtn.addEventListener('click', closeUserModal);
            closePasswordModalBtn.addEventListener('click', closePasswordModal);
            cancelPasswordModalBtn.addEventListener('click', closePasswordModal);
            
            // User role change
            document.getElementById('user-role')?.addEventListener('change', function() {
                const deptContainer = document.getElementById('department-select-container');
                if (this.value === 'director') {
                    deptContainer.classList.remove('hidden');
                    document.getElementById('user-department').required = true;
                } else {
                    deptContainer.classList.add('hidden');
                    document.getElementById('user-department').required = false;
                }
            });
            
            // Save user
            saveUserBtn.addEventListener('click', saveUser);
            
            // Add user button
            addUserBtn.addEventListener('click', () => openUserModal());
            
            // Save password
            savePasswordBtn.addEventListener('click', changePassword);
            
            // Forgot password
            document.getElementById('forgot-password')?.addEventListener('click', function() {
                alert('Please contact the system administrator to reset your password.');
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Find user
            const user = appState.users.find(u => 
                u.username === username && u.password === password && u.status === 'active'
            );
            
            if (user) {
                // Update last login
                user.lastLogin = new Date().toISOString();
                localStorage.setItem('auditPortalUsers', JSON.stringify(appState.users));
                
                // Add activity log
                addActivity(`${user.fullName} logged in`, 'system');
                
                // Set current user
                appState.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Clear form
                loginForm.reset();
                loginError.classList.add('hidden');
                
                // Show app
                showApp();
            } else {
                loginError.classList.remove('hidden');
                errorMessage.textContent = 'Invalid username or password';
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        }

        // Show main application
        function showApp() {
            loginPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Update UI based on user role
            updateUserUI();
            
            if (appState.currentUser.role === 'admin') {
                showAdminDashboard();
            } else {
                showDirectorDashboard();
            }
        }

        // Update user UI elements
        function updateUserUI() {
            const user = appState.currentUser;
            const roleText = user.role === 'admin' ? 'Administrator' : 
                            user.role === 'director' ? 'Department Director' : 'Viewer';
            
            // Update header
            document.getElementById('user-greeting').textContent = `Welcome, ${user.fullName.split(' ')[0]}`;
            document.getElementById('user-role').textContent = roleText;
            document.getElementById('username-display').textContent = user.fullName.split(' ')[0];
            document.getElementById('menu-username').textContent = user.fullName;
            document.getElementById('menu-role').textContent = roleText;
        }

        // Show admin dashboard
        function showAdminDashboard() {
            adminDashboard.classList.remove('hidden');
            directorDashboard.classList.add('hidden');
            
            loadAdminStats();
            loadUsersTable();
            loadDeptStatusTable();
        }

        // Show director dashboard
        function showDirectorDashboard() {
            adminDashboard.classList.add('hidden');
            directorDashboard.classList.remove('hidden');
            
            loadDirectorDashboard();
        }

        // Load admin statistics
        function loadAdminStats() {
            // User stats
            totalUsersEl.textContent = appState.users.length;
            const directors = appState.users.filter(u => u.role === 'director').length;
            directorCountEl.textContent = directors;
            
            // Requirements stats
            let totalPending = 0;
            let totalCompleted = 0;
            
            appState.departments.forEach(dept => {
                dept.requirements.forEach(req => {
                    if (req.status === 'pending') totalPending++;
                    if (req.status === 'completed') totalCompleted++;
                });
            });
            
            adminPendingReqsEl.textContent = totalPending;
            adminCompletedReqsEl.textContent = totalCompleted;
        }

        // Load users table
        function loadUsersTable() {
            usersTable.innerHTML = '';
            
            appState.users.forEach(user => {
                const row = document.createElement('tr');
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';
                
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' :
                                   user.status === 'inactive' ? 'bg-red-100 text-red-800' :
                                   'bg-yellow-100 text-yellow-800';
                
                const deptName = user.department ? 
                    appState.departments.find(d => d.id === user.department)?.name || 'N/A' : 
                    'N/A';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.role === 'admin' ? 'Admin' : user.role === 'director' ? 'Director' : 'Viewer'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${deptName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${lastLogin}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded ${statusClass}">
                            ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 edit-user-btn" data-id="${user.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="text-red-600 hover:text-red-900 delete-user-btn" data-id="${user.id}" ${user.id === 1 ? 'disabled' : ''}>
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </td>
                `;
                
                usersTable.appendChild(row);
            });
            
            document.getElementById('users-count').textContent = appState.users.length;
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openUserModal(parseInt(this.dataset.id));
                });
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.dataset.id);
                    if (userId !== 1 && confirm('Are you sure you want to delete this user?')) {
                        deleteUser(userId);
                    }
                });
            });
        }

        // Load department status table
        function loadDeptStatusTable() {
            deptStatusTable.innerHTML = '';
            
            appState.departments.forEach(dept => {
                const total = dept.requirements.length;
                const pending = dept.requirements.filter(r => r.status === 'pending').length;
                const inProgress = dept.requirements.filter(r => r.status === 'in-progress').length;
                const completed = dept.requirements.filter(r => r.status === 'completed').length;
                const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dept.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-pending">${pending}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-in-progress">${inProgress}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-completed">${completed}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block">${percent}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 view-dept-btn" data-id="${dept.id}">
                            <i class="fas fa-eye mr-1"></i> View Details
                        </button>
                    </td>
                `;
                
                deptStatusTable.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-dept-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.dataset.id;
                    const dept = appState.departments.find(d => d.id === deptId);
                    if (dept) {
                        alert(`Department: ${dept.name}\nTotal Requirements: ${dept.requirements.length}\nPending: ${dept.requirements.filter(r => r.status === 'pending').length}\nCompleted: ${dept.requirements.filter(r => r.status === 'completed').length}`);
                    }
                });
            });
        }

        // Load director dashboard
        function loadDirectorDashboard() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            
            if (!dept) {
                alert('No department assigned to your account. Please contact administrator.');
                return;
            }
            
            // Update UI
            directorDeptTitle.textContent = `${dept.name} - Requirements`;
            directorDeptSubtitle.textContent = `Request Date: 02 Feb 2026 | Deadline: 28 Feb 2026`;
            
            // Load stats
            updateDirectorStats(dept);
            
            // Load requirements
            appState.filteredRequirements = [...dept.requirements];
            directorTotalItemsEl.textContent = dept.requirements.length;
            renderDirectorRequirements();
            
            // Load activity feed
            loadActivityFeed(dept.id);
            
            // Setup event listeners for director dashboard
            setupDirectorEventListeners(dept);
        }

        // Update director stats
        function updateDirectorStats(dept) {
            const total = dept.requirements.length;
            const pending = dept.requirements.filter(r => r.status === 'pending').length;
            const inProgress = dept.requirements.filter(r => r.status === 'in-progress').length;
            const completed = dept.requirements.filter(r => r.status === 'completed').length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            directorTotalReqsEl.textContent = total;
            directorPendingReqsEl.textContent = pending;
            directorProgressReqsEl.textContent = inProgress;
            directorCompletedReqsEl.textContent = completed;
            
            // Update progress summary
            document.getElementById('completion-percent').textContent = `${percent}%`;
            document.getElementById('completion-bar').style.width = `${percent}%`;
            document.getElementById('summary-pending').textContent = pending;
            document.getElementById('summary-in-progress').textContent = inProgress;
            document.getElementById('summary-completed').textContent = completed;
        }

        // Render director requirements
        function renderDirectorRequirements() {
            directorRequirementsTable.innerHTML = '';
            
            const startIndex = (appState.currentPage - 1) * appState.itemsPerPage;
            const endIndex = Math.min(startIndex + appState.itemsPerPage, appState.filteredRequirements.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const req = appState.filteredRequirements[i];
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${req.id}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${req.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(req.requestDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(req.status)}">
                            ${getStatusText(req.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 update-req-btn" data-id="${req.id}">
                            <i class="fas fa-edit mr-1"></i> Update
                        </button>
                        <button class="text-gray-600 hover:text-gray-900 view-req-btn" data-id="${req.id}">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                    </td>
                `;
                
                directorRequirementsTable.appendChild(row);
            }
            
            // Update pagination info
            directorStartItemEl.textContent = appState.filteredRequirements.length > 0 ? startIndex + 1 : 0;
            directorEndItemEl.textContent = endIndex;
            
            // Update pagination buttons
            const totalPages = Math.ceil(appState.filteredRequirements.length / appState.itemsPerPage);
            directorPrevPageBtn.disabled = appState.currentPage === 1;
            directorNextPageBtn.disabled = appState.currentPage === totalPages || totalPages === 0;
            
            // Add event listeners
            document.querySelectorAll('.update-req-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openUpdateModal(parseInt(this.dataset.id));
                });
            });
            
            document.querySelectorAll('.view-req-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openViewModal(parseInt(this.dataset.id));
                });
            });
        }

        // Load activity feed
        function loadActivityFeed(deptId) {
            activityFeed.innerHTML = '';
            
            // Filter activities for this department or system-wide
            const deptActivities = appState.activities.filter(activity => 
                activity.departmentId === deptId || activity.type === 'system'
            ).slice(0, 5); // Show only 5 most recent
            
            if (deptActivities.length === 0) {
                activityFeed.innerHTML = '<div class="text-gray-500 italic text-sm">No recent activity to display</div>';
                return;
            }
            
            deptActivities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'flex items-start';
                activityItem.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <div class="w-8 h-8 rounded-full ${activity.type === 'system' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'} flex items-center justify-center">
                            <i class="fas ${activity.type === 'system' ? 'fa-cog' : 'fa-check'} text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">${activity.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTime(activity.timestamp)}</p>
                    </div>
                `;
                activityFeed.appendChild(activityItem);
            });
        }

        // Setup director event listeners
        function setupDirectorEventListeners(dept) {
            // Status filter
            if (directorStatusFilter) {
                directorStatusFilter.addEventListener('change', function() {
                    const filterValue = this.value;
                    
                    if (filterValue === 'all') {
                        appState.filteredRequirements = [...dept.requirements];
                    } else {
                        appState.filteredRequirements = dept.requirements.filter(req => req.status === filterValue);
                    }
                    
                    appState.currentPage = 1;
                    directorTotalItemsEl.textContent = appState.filteredRequirements.length;
                    renderDirectorRequirements();
                });
            }
            
            // Export button
            if (directorExportBtn) {
                directorExportBtn.addEventListener('click', function() {
                    exportDepartmentData(dept);
                });
            }
            
            // Submit all button
            if (directorSubmitAllBtn) {
                directorSubmitAllBtn.addEventListener('click', function() {
                    submitAllRequirements(dept);
                });
            }
            
            // Pagination
            if (directorPrevPageBtn) {
                directorPrevPageBtn.addEventListener('click', function() {
                    if (appState.currentPage > 1) {
                        appState.currentPage--;
                        renderDirectorRequirements();
                    }
                });
            }
            
            if (directorNextPageBtn) {
                directorNextPageBtn.addEventListener('click', function() {
                    const totalPages = Math.ceil(appState.filteredRequirements.length / appState.itemsPerPage);
                    if (appState.currentPage < totalPages) {
                        appState.currentPage++;
                        renderDirectorRequirements();
                    }
                });
            }
        }

        // Open update modal
        function openUpdateModal(id) {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            const requirement = dept.requirements.find(req => req.id === id);
            
            if (!requirement) return;
            
            appState.currentRequirementId = id;
            document.getElementById('modal-title').textContent = 'Update Requirement Status';
            document.getElementById('requirement-title').textContent = requirement.description;
            document.getElementById('requirement-detail').textContent = `${dept.name} - Requirement #${id}`;
            
            // Reset form
            document.getElementById('remarks').value = requirement.remarks || '';
            document.getElementById('receiving-date').value = requirement.receivingDate || '';
            
            // Set active status button
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('border-2', 'border-blue-500');
                if (btn.dataset.status === requirement.status) {
                    btn.classList.add('border-2', 'border-blue-500');
                }
            });
            
            // Add event listeners to status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('border-2', 'border-blue-500'));
                    this.classList.add('border-2', 'border-blue-500');
                });
            });
            
            // Save button
            saveStatusBtn.onclick = () => saveRequirementStatus(id, dept);
            
            // Submit button
            submitStatusBtn.onclick = () => submitRequirementStatus(id, dept);
            
            updateModal.classList.remove('hidden');
        }

        // Open view modal
        function openViewModal(id) {
            // Similar to openUpdateModal but in read-only mode
            openUpdateModal(id);
            document.getElementById('modal-title').textContent = 'View Requirement Details';
            
            // Disable editing
            document.querySelectorAll('.status-btn').forEach(btn => btn.disabled = true);
            document.getElementById('receiving-date').disabled = true;
            document.getElementById('remarks').disabled = true;
            saveStatusBtn.classList.add('hidden');
            submitStatusBtn.classList.add('hidden');
        }

        // Save requirement status
        function saveRequirementStatus(id, dept) {
            const requirement = dept.requirements.find(req => req.id === id);
            if (!requirement) return;
            
            // Get selected status
            let selectedStatus = 'pending';
            document.querySelectorAll('.status-btn').forEach(btn => {
                if (btn.classList.contains('border-2')) {
                    selectedStatus = btn.dataset.status;
                }
            });
            
            const oldStatus = requirement.status;
            
            // Update requirement
            requirement.status = selectedStatus;
            requirement.remarks = document.getElementById('remarks').value;
            
            // Save to localStorage
            localStorage.setItem('auditPortalDepartments', JSON.stringify(appState.departments));
            
            // Add activity log
            if (oldStatus !== selectedStatus) {
                addActivity(`Updated requirement #${id} from ${oldStatus} to ${selectedStatus}`, dept.id);
            }
            
            // Update UI
            updateDirectorStats(dept);
            renderDirectorRequirements();
            
            // Show confirmation
            showToast('Status updated successfully!');
            
            // Close modal
            closeUpdateModal();
        }

        // Submit requirement status
        function submitRequirementStatus(id, dept) {
            const requirement = dept.requirements.find(req => req.id === id);
            if (!requirement) return;
            
            // Get selected status
            let selectedStatus = 'pending';
            document.querySelectorAll('.status-btn').forEach(btn => {
                if (btn.classList.contains('border-2')) {
                    selectedStatus = btn.dataset.status;
                }
            });
            
            // For submission, we'll set it to completed if not already
            if (selectedStatus !== 'completed') {
                selectedStatus = 'completed';
                
                // Update status button UI
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.remove('border-2', 'border-blue-500');
                    if (btn.dataset.status === 'completed') {
                        btn.classList.add('border-2', 'border-blue-500');
                    }
                });
            }
            
            const oldStatus = requirement.status;
            
            // Update requirement
            requirement.status = selectedStatus;
            requirement.remarks = document.getElementById('remarks').value;
            
            // Set receiving date to today if completed
            if (selectedStatus === 'completed') {
                const today = new Date();
                requirement.receivingDate = today.toISOString().split('T')[0];
                document.getElementById('receiving-date').value = requirement.receivingDate;
            }
            
            // Save to localStorage
            localStorage.setItem('auditPortalDepartments', JSON.stringify(appState.departments));
            
            // Add activity log
            if (oldStatus !== selectedStatus) {
                addActivity(`Submitted requirement #${id} (${requirement.description.substring(0, 50)}...)`, dept.id);
            }
            
            // Update UI
            updateDirectorStats(dept);
            renderDirectorRequirements();
            
            // Show confirmation
            showToast('Requirement submitted successfully!');
            
            // Close modal
            closeUpdateModal();
        }

        // Submit all requirements
        function submitAllRequirements(dept) {
            const pendingReqs = dept.requirements.filter(req => req.status === 'pending');
            
            if (pendingReqs.length === 0) {
                alert('No pending requirements to submit!');
                return;
            }
            
            if (confirm(`Are you sure you want to submit all ${pendingReqs.length} pending requirements?`)) {
                const today = new Date().toISOString().split('T')[0];
                
                dept.requirements.forEach(req => {
                    if (req.status === 'pending') {
                        req.status = 'completed';
                        req.receivingDate = today;
                    }
                });
                
                // Save to localStorage
                localStorage.setItem('auditPortalDepartments', JSON.stringify(appState.departments));
                
                // Add activity log
                addActivity(`Submitted all ${pendingReqs.length} pending requirements`, dept.id);
                
                // Update UI
                updateDirectorStats(dept);
                renderDirectorRequirements();
                
                showToast(`All ${pendingReqs.length} requirements submitted successfully!`);
            }
        }

        // Export department data
        function exportDepartmentData(dept) {
            let csvContent = "Sr. No.,Information Requested,Request Date,Status,Remarks\n";
            
            dept.requirements.forEach(req => {
                csvContent += `${req.id},"${req.description}","${formatDate(req.requestDate)}","${getStatusText(req.status)}","${req.remarks || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dept.name.replace(/\s+/g, '_')}_Audit_Requirements.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Add activity log
            addActivity(`Exported department requirements data`, dept.id);
            
            showToast('Data exported successfully!');
        }

        // Open user modal
        function openUserModal(userId = null) {
            appState.editingUserId = userId;
            
            if (userId) {
                // Edit mode
                document.getElementById('user-modal-title').textContent = 'Edit User';
                resetPasswordBtn.classList.remove('hidden');
                
                const user = appState.users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = ''; // Don't show current password
                    document.getElementById('user-fullname').value = user.fullName;
                    document.getElementById('user-email').value = user.email || '';
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-department').value = user.department || '';
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('editing-user-id').value = userId;
                    
                    // Show/hide department based on role
                    const deptContainer = document.getElementById('department-select-container');
                    if (user.role === 'director') {
                        deptContainer.classList.remove('hidden');
                    } else {
                        deptContainer.classList.add('hidden');
                    }
                }
            } else {
                // Add mode
                document.getElementById('user-modal-title').textContent = 'Add New User';
                resetPasswordBtn.classList.add('hidden');
                document.getElementById('user-form').reset();
                document.getElementById('editing-user-id').value = '';
                document.getElementById('department-select-container').classList.add('hidden');
            }
            
            userModal.classList.remove('hidden');
        }

        // Save user
        function saveUser() {
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;
            const fullName = document.getElementById('user-fullname').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role').value;
            const department = document.getElementById('user-department').value;
            const status = document.getElementById('user-status').value;
            const editingId = document.getElementById('editing-user-id').value;
            
            // Validation
            if (!username || !fullName || !role) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!editingId && !password) {
                alert('Please provide a password for new user');
                return;
            }
            
            if (role === 'director' && !department) {
                alert('Please select a department for director role');
                return;
            }
            
            if (editingId) {
                // Update existing user
                const userIndex = appState.users.findIndex(u => u.id === parseInt(editingId));
                if (userIndex !== -1) {
                    appState.users[userIndex].username = username;
                    if (password) {
                        appState.users[userIndex].password = password;
                    }
                    appState.users[userIndex].fullName = fullName;
                    appState.users[userIndex].email = email;
                    appState.users[userIndex].role = role;
                    appState.users[userIndex].department = role === 'director' ? department : null;
                    appState.users[userIndex].status = status;
                    
                    // Add activity log
                    addActivity(`Updated user ${username}`, 'system');
                }
            } else {
                // Add new user
                const newId = Math.max(...appState.users.map(u => u.id)) + 1;
                const newUser = {
                    id: newId,
                    username,
                    password,
                    fullName,
                    email,
                    role,
                    department: role === 'director' ? department : null,
                    status,
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                };
                appState.users.push(newUser);
                
                // Add activity log
                addActivity(`Added new user ${username} (${fullName})`, 'system');
            }
            
            // Save to localStorage
            localStorage.setItem('auditPortalUsers', JSON.stringify(appState.users));
            
            // Reload admin dashboard
            loadAdminStats();
            loadUsersTable();
            
            // Show confirmation
            showToast(`User ${editingId ? 'updated' : 'added'} successfully!`);
            
            // Close modal
            closeUserModal();
        }

        // Delete user
        function deleteUser(userId) {
            // Cannot delete admin user (id: 1)
            if (userId === 1) return;
            
            const user = appState.users.find(u => u.id === userId);
            if (!user) return;
            
            appState.users = appState.users.filter(u => u.id !== userId);
            
            // Save to localStorage
            localStorage.setItem('auditPortalUsers', JSON.stringify(appState.users));
            
            // Add activity log
            addActivity(`Deleted user ${user.username}`, 'system');
            
            // Reload admin dashboard
            loadAdminStats();
            loadUsersTable();
            
            showToast('User deleted successfully!');
        }

        // Show change password modal
        function showChangePasswordModal() {
            changePasswordModal.classList.remove('hidden');
        }

        // Change password
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            
            // Validation
            if (currentPassword !== appState.currentUser.password) {
                errorDiv.querySelector('#password-error-message').textContent = 'Current password is incorrect';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.querySelector('#password-error-message').textContent = 'New password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.querySelector('#password-error-message').textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Update password
            const userIndex = appState.users.findIndex(u => u.id === appState.currentUser.id);
            if (userIndex !== -1) {
                appState.users[userIndex].password = newPassword;
                appState.currentUser.password = newPassword;
                
                // Save to localStorage
                localStorage.setItem('auditPortalUsers', JSON.stringify(appState.users));
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                
                // Add activity log
                addActivity('Changed password', appState.currentUser.department || 'system');
                
                // Show confirmation
                showToast('Password changed successfully!');
                
                // Close modal
                closePasswordModal();
                
                // Clear form
                document.getElementById('change-password-form').reset();
                errorDiv.classList.add('hidden');
            }
        }

        // Add activity log
        function addActivity(message, departmentId) {
            const activity = {
                id: Date.now(),
                message,
                departmentId,
                type: departmentId === 'system' ? 'system' : 'department',
                timestamp: new Date().toISOString()
            };
            
            appState.activities.unshift(activity); // Add to beginning
            localStorage.setItem('auditPortalActivities', JSON.stringify(appState.activities));
            
            // Update activity feed if on director dashboard
            if (appState.currentUser && appState.currentUser.role === 'director') {
                loadActivityFeed(appState.currentUser.department);
            }
        }

        // Toggle user menu
        function toggleUserMenu() {
            userMenu.classList.toggle('hidden');
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Add activity log
                addActivity(`${appState.currentUser.fullName} logged out`, 'system');
                
                appState.currentUser = null;
                localStorage.removeItem('currentUser');
                
                appContainer.classList.add('hidden');
                loginPage.classList.remove('hidden');
                
                // Reset login form
                loginForm.reset();
            }
        }

        // Close update modal
        function closeUpdateModal() {
            updateModal.classList.add('hidden');
            
            // Re-enable form elements if they were disabled in view mode
            document.querySelectorAll('.status-btn').forEach(btn => btn.disabled = false);
            document.getElementById('receiving-date').disabled = false;
            document.getElementById('remarks').disabled = false;
            saveStatusBtn.classList.remove('hidden');
            submitStatusBtn.classList.remove('hidden');
        }

        // Close user modal
        function closeUserModal() {
            userModal.classList.add('hidden');
            document.getElementById('user-form').reset();
        }

        // Close password modal
        function closePasswordModal() {
            changePasswordModal.classList.add('hidden');
            document.getElementById('change-password-form').reset();
            document.getElementById('password-error').classList.add('hidden');
        }

        // Show toast notification
        function showToast(message) {
            const toast = confirmationToast;
            const toastMessage = toast.querySelector('p:first-child');
            toastMessage.textContent = message;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Helper functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-pending';
                case 'in-progress': return 'status-in-progress';
                case 'completed': return 'status-completed';
                case 'overdue': return 'status-overdue';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                case 'overdue': return 'Overdue';
                default: return status;
            }
        }
    </script>
</body>
</html>