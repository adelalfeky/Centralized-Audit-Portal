<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Portal - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-in-progress { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-overdue { background-color: #fee2e2; color: #991b1b; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .highlight-row { background-color: #f0f9ff; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .hidden { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .folder-structure { border-left: 2px solid #d1d5db; margin-left: 10px; padding-left: 15px; }
        .file-item { transition: all 0.2s; }
        .file-item:hover { background-color: #f3f4f6; }
        .folder-icon { color: #fbbf24; }
        .pdf-icon { color: #ef4444; }
        .doc-icon { color: #3b82f6; }
        .excel-icon { color: #10b981; }
        .image-icon { color: #8b5cf6; }
        .folder-bg { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100 p-4 fade-in">
        <div class="w-full max-w-md">
            <div class="bg-white card-shadow rounded-xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white text-center">
                    <img src="img/logo-04.png" alt="Tasheer" class="h-17 w-auto mx-auto mb-4 drop-shadow-sm">
                    <h1 class="text-2xl font-bold">Centralized Audit Portal</h1>
                    <p class="opacity-90 mt-2">Tasheer - Entity-wide Diagnostic Assessment</p>
                </div>
                
                <div class="p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Sign In to Your Account</h2>
                    
                    <form id="login-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="username">Username</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-user text-gray-400"></i>
                                </div>
                                <input type="text" id="username" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your username" required>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Password</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input type="password" id="password" class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your password" required>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <button type="button" id="toggle-password" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="remember-me" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-700">Remember me</label>
                            </div>
                            <button type="button" id="forgot-password" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Forgot password?</button>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                        </button>
                    </form>
                    
                    <div id="login-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                        <i class="fas fa-exclamation-circle mr-2"></i> <span id="error-message">Invalid username or password</span>
                    </div>
                    
                    <div class="mt-6">
                        <p class="text-gray-600 text-sm mb-2 text-center font-medium">Default Test Credentials:</p>
                        <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg text-xs">
                            <div class="font-medium text-blue-900 mb-2">Admin Account:</div>
                            <div class="text-blue-800 font-mono">
                                <div>Username: <strong>admin@kpmg.com</strong></div>
                                <div>Password: <strong>Admin123</strong></div>
                            </div>
                        </div>
                        <p class="text-gray-500 text-xs mt-3 text-center">Other department accounts can be created from the admin dashboard</p>
                    </div>
                                <div class="font-medium">Solution Dev:</div>
                                <div>solutiondev / solution123</div>
                                <div class="font-medium">Tech Strategy:</div>
                                <div>techstrategy / strategy123</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center text-gray-600 text-sm">
                <p>&copy; 2026 Tasheer Audit Portal. For authorized personnel only.</p>
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden until login) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <div class="bg-blue-50 border border-blue-100 p-2 rounded-lg">
                            <img src="img/tasheer-logo.png" alt="Tasheer" class="h-12 w-auto">
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Centralized Audit Requirement Portal</h1>
                            <p class="text-gray-600" id="company-name">Tasheer - Entity-wide Diagnostic Assessment Review</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:block text-right">
                            <p class="font-medium text-gray-800" id="user-greeting">Welcome, Admin</p>
                            <p class="text-sm text-gray-600" id="user-role">Administrator</p>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 rounded-lg px-4 py-2 transition duration-200">
                                <div class="bg-blue-600 text-white h-8 w-8 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="hidden md:block">
                                    <p class="text-sm font-medium text-gray-800 truncate max-w-[120px]" id="username-display">Admin</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-600 text-xs"></i>
                            </button>
                            
                            <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
                                <div class="p-4 border-b border-gray-200">
                                    <p class="font-medium text-gray-800 truncate" id="menu-username">Admin</p>
                                    <p class="text-sm text-gray-600 truncate" id="menu-role">Administrator</p>
                                </div>
                                <div class="py-1">
                                    <a href="#" id="profile-btn" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-user-circle mr-3 text-gray-500"></i> My Profile
                                    </a>
                                    <a href="#" id="change-password-btn" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-key mr-3 text-gray-500"></i> Change Password
                                    </a>
                                    <div class="border-t border-gray-200 my-1"></div>
                                    <a href="#" id="logout-btn" class="flex items-center px-4 py-2 text-red-600 hover:bg-gray-100">
                                        <i class="fas fa-sign-out-alt mr-3"></i> Logout
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <div class="container mx-auto px-4 py-6" id="main-content">
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Administrator Dashboard</h2>
                        <p class="text-gray-600">Manage users, departments, and system settings</p>
                    </div>
                    
                    <div class="mt-4 md:mt-0 flex flex-wrap gap-3">
                        <button id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-user-plus mr-2"></i> Add New User
                        </button>
                        <button id="refresh-data-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                        </button>
                        <button id="shared-folder-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-folder-open mr-2"></i> Shared Folder
                        </button>
                    </div>
                </div>
                
                <!-- Admin Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Total Users</p>
                                <p class="text-3xl font-bold text-gray-800" id="total-users">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Department Directors</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-count">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-user-tie text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Pending Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="admin-pending-reqs">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Completed Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="admin-completed-reqs">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Management -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">User Management</h3>
                        
                        <div class="mt-3 md:mt-0">
                            <div class="relative">
                                <input type="text" id="user-search" class="border border-gray-300 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-64" placeholder="Search users...">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-200 text-center text-gray-600 text-sm">
                        <p>Showing <span id="users-count">0</span> users</p>
                    </div>
                </div>
                
                <!-- Shared Folder Configuration -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Shared Folder Configuration</h3>
                        <button id="configure-folders-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-folder-plus mr-2"></i> Configure Folders
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Root Shared Folder Path</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="folder-config-table" class="bg-white divide-y divide-gray-200">
                                <!-- Folder configuration will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Department Overview -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Department Status Overview</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Requirements</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">In Progress</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% Complete</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dept-status-table" class="bg-white divide-y divide-gray-200">
                                <!-- Department status will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Uploaded Files from Directors -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mt-6">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-green-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-file-download text-green-600 text-xl mr-3"></i>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Uploaded Files from Directors</h3>
                                    <p class="text-sm text-gray-600">View and manage files uploaded by department directors to shared folders</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Filter by Department -->
                        <div class="mb-6 flex gap-3 items-center flex-wrap">
                            <label class="text-sm font-medium text-gray-700">Filter by Department:</label>
                            <select id="admin-files-dept-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="all">All Departments</option>
                                <!-- Options will be populated from departments -->
                            </select>
                            <button id="admin-refresh-files-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center text-sm">
                                <i class="fas fa-sync-alt mr-2"></i> Refresh
                            </button>
                        </div>
                        
                        <!-- Files List -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Director</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-uploaded-files-table" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 text-sm">No files uploaded yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="director-dashboard" class="hidden">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Total Requirements</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-total-reqs">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-list-check text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Pending</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-pending-reqs">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">In Progress</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-progress-reqs">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-spinner text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-500 text-sm">Completed</p>
                                <p class="text-3xl font-bold text-gray-800" id="director-completed-reqs">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Department Header -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="director-dept-title">Department Requirements</h3>
                            <p class="text-gray-600" id="director-dept-subtitle">Request Date: 02 Feb 2026 | Deadline: 28 Feb 2026</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0 flex flex-wrap gap-3">
                            <div class="relative">
                                <select id="director-status-filter" class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-filter"></i>
                                </div>
                            </div>
                            
                            <button id="director-export-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-download mr-2"></i> Export
                            </button>
                            
                            <button id="director-submit-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-paper-plane mr-2"></i> Submit All
                            </button>
                            
                            <button id="my-folder-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-folder mr-2"></i> My Folder
                            </button>
                        </div>
                    </div>
                    
                    <!-- Requirements Table -->
                    <div class="overflow-x-auto max-h-[500px] scrollbar-hide">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sr. No.</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Information Requested</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attachments</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="director-requirements-table" class="bg-white divide-y divide-gray-200">
                                <!-- Requirements will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing <span id="director-start-item">1</span> to <span id="director-end-item">10</span> of <span id="director-total-items">0</span> requirements
                        </div>
                        <div class="flex space-x-2">
                            <button id="director-prev-page" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="director-next-page" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white card-shadow rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Progress Summary</h4>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Overall Completion</span>
                                <span id="completion-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="completion-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">Pending</span>
                                <span class="font-medium" id="summary-pending">0</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-blue-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">In Progress</span>
                                <span class="font-medium" id="summary-in-progress">0</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-3"></div>
                                <span class="text-gray-700 flex-grow">Completed</span>
                                <span class="font-medium" id="summary-completed">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white card-shadow rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Recent Activity</h4>
                        <div id="activity-feed" class="space-y-4 max-h-60 overflow-y-auto scrollbar-hide p-1">
                            <!-- Activity items will be loaded here -->
                            <div class="text-gray-500 italic text-sm">No recent activity to display</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shared Folder Upload Section -->
                <div class="bg-white card-shadow rounded-lg overflow-hidden mt-6">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-blue-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-cloud-upload-alt text-blue-600 text-xl mr-3"></i>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Shared Folder - File Upload</h3>
                                    <p class="text-sm text-gray-600">Upload supporting documents to the shared department folder</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Shared Folder Info -->
                        <div class="mb-6 p-4 border border-blue-200 bg-blue-50 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-blue-600 font-semibold uppercase tracking-wide">Local Folder Path</p>
                                    <p class="text-sm font-mono text-gray-700 mt-1" id="shared-folder-path-display">
                                        <i class="fas fa-folder mr-2 text-gray-500"></i>Not configured
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-blue-600 font-semibold uppercase tracking-wide">Shared Folder URL</p>
                                    <p class="text-sm font-mono text-gray-700 mt-1" id="shared-folder-url-display">
                                        <i class="fas fa-link mr-2 text-gray-500"></i>Not configured
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Area -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer" id="upload-drop-zone">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-700 font-medium mb-1">Drag and drop files here or click to select</p>
                            <p class="text-sm text-gray-500">Supported: PDF, Word, Excel, Images (Max 10MB per file)</p>
                            <input type="file" id="shared-folder-upload" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.bmp">
                        </div>
                        
                        <!-- Uploaded Files List -->
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-file-archive mr-2 text-gray-600"></i>
                                Uploaded Files
                            </h4>
                            <div id="uploaded-files-list" class="space-y-2 bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 italic text-sm">No files uploaded yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Update Requirement Modal (for directors) -->
        <div id="update-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white slide-in">
                <!-- Modal content same as previous version -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="modal-title">Update Requirement Status</h3>
                    <button id="close-update-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-1" id="requirement-title">Requirement Title</h4>
                        <p class="text-blue-700 text-sm" id="requirement-detail">Department - Requirement #1</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Status</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button data-status="pending" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-yellow-500 bg-white">
                                <div class="status-pending rounded-full p-2 mb-2">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <span class="text-sm font-medium">Pending</span>
                            </button>
                            <button data-status="in-progress" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-blue-500 bg-white">
                                <div class="status-in-progress rounded-full p-2 mb-2">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <span class="text-sm font-medium">In Progress</span>
                            </button>
                            <button data-status="completed" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-green-500 bg-white">
                                <div class="status-completed rounded-full p-2 mb-2">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <span class="text-sm font-medium">Completed</span>
                            </button>
                            <button data-status="overdue" class="status-btn flex flex-col items-center justify-center p-3 rounded-lg border border-gray-300 hover:border-red-500 bg-white">
                                <div class="status-overdue rounded-full p-2 mb-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <span class="text-sm font-medium">Overdue</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="receiving-date" class="block text-gray-700 text-sm font-medium mb-2">Receiving Date</label>
                        <input type="date" id="receiving-date" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="mb-6">
                        <label for="remarks" class="block text-gray-700 text-sm font-medium mb-2">Remarks/Notes</label>
                        <textarea id="remarks" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Add any comments or notes about this requirement..."></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Upload Supporting Document (Optional)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">Drag & drop files here or</p>
                            <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg inline-block">
                                <i class="fas fa-upload mr-2"></i> Browse Files
                            </label>
                            <input type="file" id="file-upload" class="hidden" multiple>
                            <p class="text-gray-500 text-xs mt-3">Maximum file size: 10MB. Supported formats: PDF, DOC, XLS, JPG, PNG</p>
                        </div>
                        <div id="file-list" class="mt-3 space-y-2"></div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-update-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="save-status-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save Changes</button>
                    <button id="submit-status-btn" class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                        <i class="fas fa-paper-plane mr-2"></i> Submit
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Department Folder Modal (for directors) -->
        <div id="folder-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="folder-modal-title">My Department Folder</h3>
                    <button id="close-folder-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-folder text-2xl text-green-600 mr-3"></i>
                            <div>
                                <h4 class="font-medium text-green-800" id="dept-folder-name">Department Folder</h4>
                                <p class="text-green-700 text-sm" id="dept-folder-path">Path: /Shared/Audit_Files/Department/</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h5 class="font-medium text-gray-700">Folder Contents</h5>
                            <button id="refresh-folder-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="folder-contents" class="border border-gray-200 rounded-lg p-4 min-h-[300px]">
                            <!-- Folder structure will be loaded here -->
                            <div class="text-center text-gray-500 p-8">
                                <i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i>
                                <p class="text-lg">Loading folder contents...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-share-alt text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <strong>Shared Folder Access:</strong> This folder is part of the shared directory accessible by administrators. 
                                    All uploaded files are automatically synced to the shared location.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="close-folder-modal-btn" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Close</button>
                    <button id="download-folder-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                        <i class="fas fa-download mr-2"></i> Download All
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Admin Shared Folder Modal -->
        <div id="shared-folder-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-4/5 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Shared Folder - All Departments</h3>
                    <button id="close-shared-folder-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-folder-open text-2xl text-purple-600 mr-3"></i>
                            <div>
                                <h4 class="font-medium text-purple-800">Shared Audit Files Directory</h4>
                                <p class="text-purple-700 text-sm">Path: /Shared/Audit_Files/</p>
                                <p class="text-purple-700 text-xs mt-1">Total Size: <span id="shared-folder-size">0 MB</span> | Last Updated: <span id="shared-folder-updated">Just now</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h5 class="font-medium text-gray-700">Department Folders</h5>
                            <div class="flex space-x-2">
                                <button id="refresh-shared-folder-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                                </button>
                                <button id="upload-to-shared-btn" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    <i class="fas fa-upload mr-1"></i> Upload File
                                </button>
                            </div>
                        </div>
                        
                        <div id="shared-folder-contents" class="border border-gray-200 rounded-lg p-4 min-h-[400px]">
                            <!-- Shared folder structure will be loaded here -->
                            <div class="text-center text-gray-500 p-8">
                                <i class="fas fa-server text-4xl text-gray-300 mb-3"></i>
                                <p class="text-lg">Loading shared folder contents...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h6 class="font-medium text-gray-700 mb-2">Folder Statistics</h6>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Total Departments</span>
                                    <span class="text-sm font-medium" id="total-dept-folders">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Total Files</span>
                                    <span class="text-sm font-medium" id="total-shared-files">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Total Size</span>
                                    <span class="text-sm font-medium" id="total-shared-size">0 MB</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h6 class="font-medium text-gray-700 mb-2">Recent Uploads</h6>
                            <div id="recent-uploads-list" class="space-y-2 max-h-32 overflow-y-auto">
                                <div class="text-sm text-gray-500 italic">No recent uploads</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h6 class="font-medium text-gray-700 mb-2">Actions</h6>
                            <div class="space-y-2">
                                <button id="download-all-btn" class="w-full text-left text-sm text-blue-600 hover:text-blue-800 p-2 hover:bg-white rounded">
                                    <i class="fas fa-download mr-2"></i> Download All Files
                                </button>
                                <button id="cleanup-folder-btn" class="w-full text-left text-sm text-red-600 hover:text-red-800 p-2 hover:bg-white rounded">
                                    <i class="fas fa-trash-alt mr-2"></i> Clean Empty Folders
                                </button>
                                <button id="export-structure-btn" class="w-full text-left text-sm text-green-600 hover:text-green-800 p-2 hover:bg-white rounded">
                                    <i class="fas fa-file-export mr-2"></i> Export Folder Structure
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="close-shared-modal-btn" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit User Modal (for admin) -->
        <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="user-modal-title">Add New User</h3>
                    <button id="close-user-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <form id="user-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-username">Username *</label>
                            <input type="text" id="user-username" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., johndoe" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-password">Password *</label>
                            <input type="password" id="user-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimum 6 characters" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-fullname">Full Name *</label>
                            <input type="text" id="user-fullname" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., John Doe" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-email">Email Address</label>
                            <input type="email" id="user-email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., john.doe@tasheer.com">
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-role-select">Role *</label>
                            <select id="user-role-select" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select Role</option>
                                <option value="admin">Administrator</option>
                                <option value="director">Department Director</option>
                                <option value="viewer">Viewer (Read-only)</option>
                            </select>
                        </div>
                        
                        <div class="mb-5 hidden" id="department-select-container">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-department">Department *</label>
                            <select id="user-department" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Department</option>
                                <option value="corporate-it">Corporate IT</option>
                                <option value="data-analytics">Data Analytics & Business Intelligence</option>
                                <option value="infrastructure">Infrastructure & Operations</option>
                                <option value="platforms">Platforms and IT Solution Operations</option>
                                <option value="quality-assurance">Quality Assurance</option>
                                <option value="solution-dev">Solution Development & Delivery</option>
                                <option value="tech-strategy">Tech Strategy & Enterprise Architecture</option>
                            </select>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="user-status">Status</label>
                            <select id="user-status" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending Activation</option>
                            </select>
                        </div>
                        
                        <input type="hidden" id="editing-user-id" value="">
                    </form>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-user-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="reset-password-btn" class="px-5 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium hidden">Reset Password</button>
                    <button id="save-user-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save User</button>
                </div>
            </div>
        </div>
        
        <!-- Change Password Modal -->
        <div id="change-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Change Password</h3>
                    <button id="close-password-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <form id="change-password-form">
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="current-password">Current Password *</label>
                            <input type="password" id="current-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="new-password">New Password *</label>
                            <input type="password" id="new-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                        </div>
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="confirm-password">Confirm New Password *</label>
                            <input type="password" id="confirm-password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div id="password-error" class="mb-5 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                            <i class="fas fa-exclamation-circle mr-2"></i> <span id="password-error-message">Passwords do not match</span>
                        </div>
                    </form>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-password-modal" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="save-password-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Change Password</button>
                </div>
            </div>
        </div>
        
        <!-- Folder Configuration Modal -->
        <div id="folder-config-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 shadow-lg rounded-md bg-white slide-in">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Configure Shared Folders for Departments</h3>
                    <button id="close-folder-config-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="py-4">
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Browse and select a root shared folder for each department. Files uploaded by department directors will be saved here.</p>
                    </div>
                    
                    <div id="folder-config-list" class="space-y-4">
                        <!-- Department folder configurations will be loaded here -->
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="cancel-folder-config" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Cancel</button>
                    <button id="save-folder-config" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save Configuration</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Toast -->
        <div id="confirmation-toast" class="fixed bottom-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg hidden z-50 slide-in">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-xl mr-3"></i>
                <div>
                    <p class="font-medium">Operation completed successfully!</p>
                    <p class="text-sm opacity-90" id="toast-message">Your changes have been saved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load external department requirement files -->
    <script src="departments-corporate-it.js"></script>
    <script src="departments-data-analytics.js"></script>
    <script src="departments-infrastructure.js"></script>
    <script src="departments-platforms.js"></script>
    <script src="departments-quality-assurance.js"></script>
    <script src="departments-solution-dev.js"></script>
    <script src="departments-tech-strategy.js"></script>
    <script src="js/api-client.js"></script>

    <script>
        // Application State
        const appState = {
            currentUser: null,
            users: [],
            departments: [],
            requirements: [],
            filteredRequirements: [],
            currentPage: 1,
            itemsPerPage: 10,
            currentRequirementId: null,
            editingUserId: null,
            activities: [],
            fileSystem: {},
            uploadedFiles: {} // Temporary storage for files being uploaded
        };

        // Initialize default data
        async function initializeData() {
            try {
                console.log('[Init] Starting data initialization...');
                // Load data from server API
                appState.departments = await apiClient.getDepartments();
                console.log('[Init] Departments loaded:', appState.departments);
                
                appState.users = [];  // Users will be loaded per-user after login
                appState.activities = [];
                appState.uploadedFiles = {};
                appState.folderConfig = await apiClient.getFolderConfig();
                console.log('[Init] Folder config loaded:', appState.folderConfig);
                
                appState.fileSystem = {};
                console.log('[Init] Data initialization complete');
            } catch (error) {
                console.error('[Init] Error initializing data:', error);
                // If server is not available, show error but don't block login
                showToast('Note: Server API may not be fully available. You can still try to login.', 'warning');
            }
        }

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const errorMessage = document.getElementById('error-message');
        
        const adminDashboard = document.getElementById('admin-dashboard');
        const directorDashboard = document.getElementById('director-dashboard');
        
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        
        const totalUsersEl = document.getElementById('total-users');
        const directorCountEl = document.getElementById('director-count');
        const adminPendingReqsEl = document.getElementById('admin-pending-reqs');
        const adminCompletedReqsEl = document.getElementById('admin-completed-reqs');
        const usersTable = document.getElementById('users-table');
        const deptStatusTable = document.getElementById('dept-status-table');
        const addUserBtn = document.getElementById('add-user-btn');
        const sharedFolderBtn = document.getElementById('shared-folder-btn');
        const myFolderBtn = document.getElementById('my-folder-btn');
        
        const directorDeptTitle = document.getElementById('director-dept-title');
        const directorDeptSubtitle = document.getElementById('director-dept-subtitle');
        const directorTotalReqsEl = document.getElementById('director-total-reqs');
        const directorPendingReqsEl = document.getElementById('director-pending-reqs');
        const directorProgressReqsEl = document.getElementById('director-progress-reqs');
        const directorCompletedReqsEl = document.getElementById('director-completed-reqs');
        const directorRequirementsTable = document.getElementById('director-requirements-table');
        const directorStatusFilter = document.getElementById('director-status-filter');
        const directorExportBtn = document.getElementById('director-export-btn');
        const directorSubmitAllBtn = document.getElementById('director-submit-all-btn');
        const directorPrevPageBtn = document.getElementById('director-prev-page');
        const directorNextPageBtn = document.getElementById('director-next-page');
        const directorStartItemEl = document.getElementById('director-start-item');
        const directorEndItemEl = document.getElementById('director-end-item');
        const directorTotalItemsEl = document.getElementById('director-total-items');
        
        const updateModal = document.getElementById('update-modal');
        const closeUpdateModalBtn = document.getElementById('close-update-modal');
        const cancelUpdateModalBtn = document.getElementById('cancel-update-modal');
        const saveStatusBtn = document.getElementById('save-status-btn');
        const submitStatusBtn = document.getElementById('submit-status-btn');
        const fileUpload = document.getElementById('file-upload');
        const fileList = document.getElementById('file-list');
        
        const folderModal = document.getElementById('folder-modal');
        const closeFolderModalBtn = document.getElementById('close-folder-modal');
        const closeFolderModalBtn2 = document.getElementById('close-folder-modal-btn');
        const refreshFolderBtn = document.getElementById('refresh-folder-btn');
        const downloadFolderBtn = document.getElementById('download-folder-btn');
        
        const sharedFolderModal = document.getElementById('shared-folder-modal');
        const closeSharedFolderModalBtn = document.getElementById('close-shared-folder-modal');
        const closeSharedModalBtn = document.getElementById('close-shared-modal-btn');
        const refreshSharedFolderBtn = document.getElementById('refresh-shared-folder-btn');
        
        const userModal = document.getElementById('user-modal');
        const closeUserModalBtn = document.getElementById('close-user-modal');
        const cancelUserModalBtn = document.getElementById('cancel-user-modal');
        const saveUserBtn = document.getElementById('save-user-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        
        const changePasswordModal = document.getElementById('change-password-modal');
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const cancelPasswordModalBtn = document.getElementById('cancel-password-modal');
        const savePasswordBtn = document.getElementById('save-password-btn');
        
        const confirmationToast = document.getElementById('confirmation-toast');
        const activityFeed = document.getElementById('activity-feed');
        
        const folderConfigModal = document.getElementById('folder-config-modal');
        const closeFolderConfigModalBtn = document.getElementById('close-folder-config-modal');
        const cancelFolderConfigBtn = document.getElementById('cancel-folder-config');
        const saveFolderConfigBtn = document.getElementById('save-folder-config');
        const configureFoldersBtn = document.getElementById('configure-folders-btn');
        const folderConfigTable = document.getElementById('folder-config-table');
        const folderConfigList = document.getElementById('folder-config-list');

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[App] DOMContentLoaded fired');
            await initializeData();
            setupEventListeners();
            console.log('[App] Initialization complete');
            
            // Check if user is already logged in (token exists)
            if (apiClient.getToken()) {
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser) {
                        appState.currentUser = JSON.parse(savedUser);
                        await showApp();
                    }
                } catch (e) {
                    apiClient.logout();
                    localStorage.removeItem('currentUser');
                }
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            console.log('[Setup] Setting up event listeners...');
            
            // Login form
            if (loginForm) {
                console.log('[Setup] Attaching login form handler');
                loginForm.addEventListener('submit', handleLogin);
            } else {
                console.error('[Setup] Login form not found!');
            }
            
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', togglePasswordVisibility);
            }
            
            // User menu
            userMenuBtn.addEventListener('click', toggleUserMenu);
            logoutBtn.addEventListener('click', handleLogout);
            changePasswordBtn.addEventListener('click', showChangePasswordModal);
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === updateModal) closeUpdateModal();
                if (event.target === folderModal) closeFolderModal();
                if (event.target === sharedFolderModal) closeSharedFolderModal();
                if (event.target === userModal) closeUserModal();
                if (event.target === changePasswordModal) closePasswordModal();
                if (event.target === folderConfigModal) closeFolderConfigModal();
                
                // Close user menu if clicking outside
                if (!event.target.closest('#user-menu-btn') && !event.target.closest('#user-menu')) {
                    userMenu.classList.add('hidden');
                }
            });
            
            // Modals
            closeUpdateModalBtn.addEventListener('click', closeUpdateModal);
            cancelUpdateModalBtn.addEventListener('click', closeUpdateModal);
            closeFolderModalBtn.addEventListener('click', closeFolderModal);
            closeFolderModalBtn2.addEventListener('click', closeFolderModal);
            closeSharedFolderModalBtn.addEventListener('click', closeSharedFolderModal);
            closeSharedModalBtn.addEventListener('click', closeSharedFolderModal);
            closeUserModalBtn.addEventListener('click', closeUserModal);
            cancelUserModalBtn.addEventListener('click', closeUserModal);
            closePasswordModalBtn.addEventListener('click', closePasswordModal);
            cancelPasswordModalBtn.addEventListener('click', closePasswordModal);
            
            // Folder configuration
            closeFolderConfigModalBtn.addEventListener('click', closeFolderConfigModal);
            cancelFolderConfigBtn.addEventListener('click', closeFolderConfigModal);
            configureFoldersBtn.addEventListener('click', openFolderConfigModal);
            saveFolderConfigBtn.addEventListener('click', saveFolderConfiguration);
            
            // User role change
            document.getElementById('user-role-select')?.addEventListener('change', function() {
                const deptContainer = document.getElementById('department-select-container');
                if (this.value === 'director') {
                    deptContainer.classList.remove('hidden');
                    document.getElementById('user-department').required = true;
                } else {
                    deptContainer.classList.add('hidden');
                    document.getElementById('user-department').required = false;
                }
            });
            
            // Save user
            saveUserBtn.addEventListener('click', saveUser);
            
            // Add user button
            addUserBtn.addEventListener('click', () => openUserModal());
            
            // Save password
            savePasswordBtn.addEventListener('click', changePassword);
            
            // Forgot password
            document.getElementById('forgot-password')?.addEventListener('click', function() {
                alert('Please contact the system administrator to reset your password.');
            });
            
            // File upload
            fileUpload.addEventListener('change', handleFileUpload);
            
            // Folder buttons
            myFolderBtn.addEventListener('click', showMyFolder);
            sharedFolderBtn.addEventListener('click', showSharedFolder);
            refreshFolderBtn.addEventListener('click', refreshMyFolder);
            downloadFolderBtn.addEventListener('click', downloadMyFolder);
            refreshSharedFolderBtn.addEventListener('click', refreshSharedFolder);
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('[Login] Form submitted');
            console.log('[Login] Username:', username, 'Password:', password ? '[filled]' : '[empty]');
            
            if (!username || !password) {
                console.error('[Login] Form validation failed - missing fields');
                loginError.classList.remove('hidden');
                errorMessage.textContent = 'Please fill in all fields';
                return;
            }
            
            try {
                console.log('[Login] Attempting login with username:', username);
                
                // Authenticate with server API
                const user = await apiClient.login(username, password);
                console.log('[Login] Login successful:', user);
                
                // Set current user
                appState.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Ensure department folder exists
                if (user.role === 'director' && user.department) {
                    ensureDepartmentFolderExists(user.department);
                }
                
                // Clear form
                loginForm.reset();
                loginError.classList.add('hidden');
                
                // Show app
                await showApp();
            } catch (error) {
                console.error('[Login] Login failed:', error);
                loginError.classList.remove('hidden');
                errorMessage.textContent = error.message || 'Invalid username or password';
            }
        }

        // Ensure department folder exists in file system
        function ensureDepartmentFolderExists(departmentId) {
            const dept = appState.departments.find(d => d.id === departmentId);
            if (!dept) return;
            
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Check if folder exists, if not create it
            if (!appState.fileSystem.Shared?.Audit_Files?.[deptFolderName]) {
                // Create department folder
                if (!appState.fileSystem.Shared) appState.fileSystem.Shared = {};
                if (!appState.fileSystem.Shared.Audit_Files) appState.fileSystem.Shared.Audit_Files = {};
                appState.fileSystem.Shared.Audit_Files[deptFolderName] = {};
                
                // Add activity log
                addActivity(`Created department folder: ${dept.name}`, 'system');
            }
            
            return deptFolderName;
        }

        // Ensure requirement subfolder exists
        function ensureRequirementFolderExists(departmentId, requirementId) {
            const dept = appState.departments.find(d => d.id === departmentId);
            if (!dept) return null;
            
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            const requirementFolderName = `Requirement_${requirementId}`;
            
            // Check if requirement folder exists, if not create it
            if (!appState.fileSystem.Shared?.Audit_Files?.[deptFolderName]?.[requirementFolderName]) {
                // Create requirement folder
                if (!appState.fileSystem.Shared.Audit_Files[deptFolderName]) {
                    appState.fileSystem.Shared.Audit_Files[deptFolderName] = {};
                }
                appState.fileSystem.Shared.Audit_Files[deptFolderName][requirementFolderName] = {
                    '_metadata': {
                        created: new Date().toISOString(),
                        requirementId: requirementId,
                        requirementDescription: dept.requirements.find(r => r.id === requirementId)?.description || '',
                        lastUpdated: new Date().toISOString()
                    }
                };
                
                // Add activity log
                addActivity(`Created folder for requirement #${requirementId} in ${dept.name}`, departmentId);
            }
            
            return {
                deptFolder: deptFolderName,
                reqFolder: requirementFolderName,
                fullPath: `/Shared/Audit_Files/${deptFolderName}/${requirementFolderName}/`
            };
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        }

        // Show main application
        async function showApp() {
            try {
                console.log('[App] Showing app interface for user:', appState.currentUser?.username);
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Update UI based on user role
                updateUserUI();
                
                if (appState.currentUser.role === 'admin') {
                    console.log('[App] Loading admin dashboard');
                    await showAdminDashboard();
                } else {
                    console.log('[App] Loading director dashboard');
                    await showDirectorDashboard();
                }
                console.log('[App] Dashboard displayed successfully');
            } catch (error) {
                console.error('[App] Error showing app:', error);
                throw error;
            }
        }

        // Update user UI elements
        function updateUserUI() {
            try {
                const user = appState.currentUser;
                const roleText = user.role === 'admin' ? 'Administrator' : 
                                user.role === 'director' ? 'Department Director' : 'Viewer';
                
                // Update header elements safely
                const userGreeting = document.getElementById('user-greeting');
                const userRole = document.getElementById('user-role');
                const usernameDisplay = document.getElementById('username-display');
                const menuUsername = document.getElementById('menu-username');
                const menuRole = document.getElementById('menu-role');
                
                if (userGreeting) userGreeting.textContent = `Welcome, ${user.fullName.split(' ')[0]}`;
                if (userRole) userRole.textContent = roleText;
                if (usernameDisplay) usernameDisplay.textContent = user.fullName.split(' ')[0];
                if (menuUsername) menuUsername.textContent = user.fullName;
                if (menuRole) menuRole.textContent = roleText;
                
                console.log('[UI] User UI updated');
            } catch (error) {
                console.error('[UI] Error updating user UI:', error);
                throw error;
            }
        }

        // Show admin dashboard
        async function showAdminDashboard() {
            adminDashboard.classList.remove('hidden');
            directorDashboard.classList.add('hidden');
            
            // Reload departments and users from API to get fresh data
            try {
                appState.departments = await apiClient.getDepartments();
                appState.users = await apiClient.getUsers();
                console.log('[Admin] Data reloaded');
            } catch (error) {
                console.error('[Admin] Error reloading data:', error);
            }
            
            loadAdminStats();
            loadUsersTable();
            loadDeptStatusTable();
        }

        // Show director dashboard
        async function showDirectorDashboard() {
            adminDashboard.classList.add('hidden');
            directorDashboard.classList.remove('hidden');
            
            // Reload departments from API to get fresh requirements data
            try {
                appState.departments = await apiClient.getDepartments();
                console.log('[Director] Departments reloaded:', appState.departments);
            } catch (error) {
                console.error('[Director] Error reloading departments:', error);
            }
            
            loadDirectorDashboard();
        }

        // Load admin statistics
        function loadAdminStats() {
            // User stats
            totalUsersEl.textContent = appState.users.length;
            const directors = appState.users.filter(u => u.role === 'director').length;
            directorCountEl.textContent = directors;
            
            // Requirements stats
            let totalPending = 0;
            let totalCompleted = 0;
            
            appState.departments.forEach(dept => {
                dept.requirements.forEach(req => {
                    if (req.status === 'pending') totalPending++;
                    if (req.status === 'completed') totalCompleted++;
                });
            });
            
            adminPendingReqsEl.textContent = totalPending;
            adminCompletedReqsEl.textContent = totalCompleted;
            
            // Load folder configuration table
            loadFolderConfigTable();
            
            // Load uploaded files table and setup filters
            loadUploadedFilesForAdmin();
            setupAdminFileFilters();
        }
        
        // Setup admin file filters
        function setupAdminFileFilters() {
            const deptFilter = document.getElementById('admin-files-dept-filter');
            const refreshBtn = document.getElementById('admin-refresh-files-btn');
            
            if (deptFilter) {
                // Clear existing options except "All"
                while (deptFilter.options.length > 1) {
                    deptFilter.remove(1);
                }
                
                // Add department options
                appState.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    deptFilter.appendChild(option);
                });
                
                // Add change event listener
                deptFilter.addEventListener('change', () => {
                    loadUploadedFilesForAdmin();
                });
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadUploadedFilesForAdmin();
                    showToast('Files list refreshed');
                });
            }
        }
        
        // Load folder configuration table
        function loadFolderConfigTable() {
            folderConfigTable.innerHTML = '';
            
            appState.departments.forEach(dept => {
                const folderPath = appState.folderConfig[dept.id]?.path || '';
                const sharedUrl = appState.folderConfig[dept.id]?.sharedUrl || '';
                const isConfigured = (folderPath !== '' || sharedUrl !== '');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dept.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        <div class="space-y-2">
                            ${folderPath ? `<div class="font-mono text-xs bg-gray-50 p-2 rounded"><i class="fas fa-folder mr-1"></i>${folderPath}</div>` : ''}
                            ${sharedUrl ? `<div class="font-mono text-xs bg-blue-50 p-2 rounded"><i class="fas fa-link mr-1"></i><a href="${sharedUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">${sharedUrl.length > 50 ? sharedUrl.substring(0, 50) + '...' : sharedUrl}</a></div>` : ''}
                            ${!folderPath && !sharedUrl ? '<span class="text-gray-400 italic">Not configured</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded ${isConfigured ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${isConfigured ? ' Configured' : ' Pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 edit-folder-btn" data-dept="${dept.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                    </td>
                `;
                
                folderConfigTable.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-folder-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openFolderConfigModal();
                });
            });
        }

        // Load users table
        function loadUsersTable() {
            usersTable.innerHTML = '';
            
            appState.users.forEach(user => {
                const row = document.createElement('tr');
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';
                
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' :
                                   user.status === 'inactive' ? 'bg-red-100 text-red-800' :
                                   'bg-yellow-100 text-yellow-800';
                
                const deptName = user.department ? 
                    appState.departments.find(d => d.id === user.department)?.name || 'N/A' : 
                    'N/A';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.role === 'admin' ? 'Admin' : user.role === 'director' ? 'Director' : 'Viewer'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${deptName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${lastLogin}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded ${statusClass}">
                            ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 edit-user-btn" data-id="${user.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="text-red-600 hover:text-red-900 delete-user-btn" data-id="${user.id}" ${user.id === 1 ? 'disabled' : ''}>
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </td>
                `;
                
                usersTable.appendChild(row);
            });
            
            document.getElementById('users-count').textContent = appState.users.length;
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openUserModal(parseInt(this.dataset.id));
                });
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.dataset.id);
                    if (userId !== 1 && confirm('Are you sure you want to delete this user?')) {
                        deleteUser(userId);
                    }
                });
            });
        }

        // Load department status table
        function loadDeptStatusTable() {
            deptStatusTable.innerHTML = '';
            
            appState.departments.forEach(dept => {
                const total = dept.requirements.length;
                const pending = dept.requirements.filter(r => r.status === 'pending').length;
                const inProgress = dept.requirements.filter(r => r.status === 'in-progress').length;
                const completed = dept.requirements.filter(r => r.status === 'completed').length;
                const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dept.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-pending">${pending}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-in-progress">${inProgress}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-medium rounded status-completed">${completed}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block">${percent}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 view-dept-btn" data-id="${dept.id}">
                            <i class="fas fa-eye mr-1"></i> View Details
                        </button>
                    </td>
                `;
                
                deptStatusTable.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-dept-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deptId = this.dataset.id;
                    const dept = appState.departments.find(d => d.id === deptId);
                    if (dept) {
                        alert(`Department: ${dept.name}\nTotal Requirements: ${dept.requirements.length}\nPending: ${dept.requirements.filter(r => r.status === 'pending').length}\nCompleted: ${dept.requirements.filter(r => r.status === 'completed').length}`);
                    }
                });
            });
        }

        // Load director dashboard
        function loadDirectorDashboard() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            
            if (!dept) {
                alert('No department assigned to your account. Please contact administrator.');
                return;
            }
            
            // Update UI
            directorDeptTitle.textContent = `${dept.name} - Requirements`;
            directorDeptSubtitle.textContent = `Request Date: 02 Feb 2026 | Deadline: 28 Feb 2026`;
            
            // Load stats
            updateDirectorStats(dept);
            
            // Load requirements
            appState.filteredRequirements = [...dept.requirements];
            directorTotalItemsEl.textContent = dept.requirements.length;
            renderDirectorRequirements();
            
            // Load activity feed
            loadActivityFeed(dept.id);
            
            // Initialize shared folder upload
            initializeSharedFolderUpload();
            
            // Setup event listeners for director dashboard
            setupDirectorEventListeners(dept);
        }

        // Update director stats
        function updateDirectorStats(dept) {
            const total = dept.requirements.length;
            const pending = dept.requirements.filter(r => r.status === 'pending').length;
            const inProgress = dept.requirements.filter(r => r.status === 'in-progress').length;
            const completed = dept.requirements.filter(r => r.status === 'completed').length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            directorTotalReqsEl.textContent = total;
            directorPendingReqsEl.textContent = pending;
            directorProgressReqsEl.textContent = inProgress;
            directorCompletedReqsEl.textContent = completed;
            
            // Update progress summary
            document.getElementById('completion-percent').textContent = `${percent}%`;
            document.getElementById('completion-bar').style.width = `${percent}%`;
            document.getElementById('summary-pending').textContent = pending;
            document.getElementById('summary-in-progress').textContent = inProgress;
            document.getElementById('summary-completed').textContent = completed;
        }

        // Render director requirements
        function renderDirectorRequirements() {
            directorRequirementsTable.innerHTML = '';
            
            const startIndex = (appState.currentPage - 1) * appState.itemsPerPage;
            const endIndex = Math.min(startIndex + appState.itemsPerPage, appState.filteredRequirements.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const req = appState.filteredRequirements[i];
                const fileCount = req.files ? req.files.length : 0;
                
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${i + 1}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${req.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(req.requestDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(req.status)}">
                            ${getStatusText(req.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${fileCount > 0 ? 
                            `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-paperclip mr-1"></i> ${fileCount} file${fileCount !== 1 ? 's' : ''}
                            </span>` : 
                            '<span class="text-gray-400 text-xs">No files</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 update-req-btn" data-id="${req.id}">
                            <i class="fas fa-edit mr-1"></i> Update
                        </button>
                        <button class="text-gray-600 hover:text-gray-900 view-req-btn" data-id="${req.id}">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                    </td>
                `;
                
                directorRequirementsTable.appendChild(row);
            }
            
            // Update pagination info
            directorStartItemEl.textContent = appState.filteredRequirements.length > 0 ? startIndex + 1 : 0;
            directorEndItemEl.textContent = endIndex;
            
            // Update pagination buttons
            const totalPages = Math.ceil(appState.filteredRequirements.length / appState.itemsPerPage);
            directorPrevPageBtn.disabled = appState.currentPage === 1;
            directorNextPageBtn.disabled = appState.currentPage === totalPages || totalPages === 0;
            
            // Add event listeners
            document.querySelectorAll('.update-req-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openUpdateModal(parseInt(this.dataset.id));
                });
            });
            
            document.querySelectorAll('.view-req-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openViewModal(parseInt(this.dataset.id));
                });
            });
        }

        // Load activity feed
        function loadActivityFeed(deptId) {
            activityFeed.innerHTML = '';
            
            // Filter activities for this department or system-wide
            const deptActivities = appState.activities.filter(activity => 
                activity.departmentId === deptId || activity.type === 'system'
            ).slice(0, 5); // Show only 5 most recent
            
            if (deptActivities.length === 0) {
                activityFeed.innerHTML = '<div class="text-gray-500 italic text-sm">No recent activity to display</div>';
                return;
            }
            
            deptActivities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'flex items-start';
                activityItem.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <div class="w-8 h-8 rounded-full ${activity.type === 'system' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'} flex items-center justify-center">
                            <i class="fas ${activity.type === 'system' ? 'fa-cog' : 'fa-check'} text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">${activity.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTime(activity.timestamp)}</p>
                    </div>
                `;
                activityFeed.appendChild(activityItem);
            });
        }

        // Setup director event listeners
        function setupDirectorEventListeners(dept) {
            // Status filter
            if (directorStatusFilter) {
                directorStatusFilter.addEventListener('change', function() {
                    const filterValue = this.value;
                    
                    if (filterValue === 'all') {
                        appState.filteredRequirements = [...dept.requirements];
                    } else {
                        appState.filteredRequirements = dept.requirements.filter(req => req.status === filterValue);
                    }
                    
                    appState.currentPage = 1;
                    directorTotalItemsEl.textContent = appState.filteredRequirements.length;
                    renderDirectorRequirements();
                });
            }
            
            // Export button
            if (directorExportBtn) {
                directorExportBtn.addEventListener('click', function() {
                    exportDepartmentData(dept);
                });
            }
            
            // Submit all button
            if (directorSubmitAllBtn) {
                directorSubmitAllBtn.addEventListener('click', function() {
                    submitAllRequirements(dept);
                });
            }
            
            // Pagination
            if (directorPrevPageBtn) {
                directorPrevPageBtn.addEventListener('click', function() {
                    if (appState.currentPage > 1) {
                        appState.currentPage--;
                        renderDirectorRequirements();
                    }
                });
            }
            
            if (directorNextPageBtn) {
                directorNextPageBtn.addEventListener('click', function() {
                    const totalPages = Math.ceil(appState.filteredRequirements.length / appState.itemsPerPage);
                    if (appState.currentPage < totalPages) {
                        appState.currentPage++;
                        renderDirectorRequirements();
                    }
                });
            }
        }

        // Open update modal
        function openUpdateModal(id) {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            const requirement = dept.requirements.find(req => req.id === id);
            
            if (!requirement) {
                console.error('Requirement not found:', id);
                return;
            }
            
            appState.currentRequirementId = id;
            document.getElementById('modal-title').textContent = 'Update Requirement Status';
            document.getElementById('requirement-title').textContent = requirement.description;
            document.getElementById('requirement-detail').textContent = `${dept.name} - Requirement #${id}`;
            
            // Reset form
            document.getElementById('remarks').value = requirement.remarks || '';
            document.getElementById('receiving-date').value = requirement.receivingDate || '';
            
            // Set active status button
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('border-2', 'border-blue-500');
                if (btn.dataset.status === requirement.status) {
                    btn.classList.add('border-2', 'border-blue-500');
                }
            });
            
            // Add event listeners to status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('border-2', 'border-blue-500'));
                    this.classList.add('border-2', 'border-blue-500');
                });
            });
            
            // Save button
            saveStatusBtn.onclick = () => saveRequirementStatus(id, dept);
            
            // Submit button
            submitStatusBtn.onclick = () => submitRequirementStatus(id, dept);
            
            updateModal.classList.remove('hidden');
        }

        // Load existing files for a requirement
        function loadExistingFiles(reqId, dept, folderInfo) {
            fileList.innerHTML = '';
            
            // Check if requirement has files in department data
            const requirement = dept.requirements.find(r => r.id === reqId);
            const existingFiles = requirement.files || [];
            
            // Also check file system
            let fileSystemFiles = [];
            if (folderInfo && appState.fileSystem.Shared?.Audit_Files?.[folderInfo.deptFolder]?.[folderInfo.reqFolder]) {
                const folder = appState.fileSystem.Shared.Audit_Files[folderInfo.deptFolder][folderInfo.reqFolder];
                fileSystemFiles = Object.keys(folder)
                    .filter(key => key !== '_metadata')
                    .map(key => ({
                        id: key,
                        name: folder[key].name,
                        size: folder[key].size,
                        type: folder[key].type,
                        uploaded: folder[key].uploaded
                    }));
            }
            
            // Combine files
            const allFiles = [...existingFiles, ...fileSystemFiles];
            
            if (allFiles.length === 0) {
                fileList.innerHTML = '<div class="text-gray-500 italic text-sm text-center p-4">No files uploaded yet</div>';
                return;
            }
            
            allFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item bg-gray-50 p-3 rounded-lg flex items-center justify-between';
                fileItem.dataset.fileId = file.id;
                
                const fileIcon = getFileIcon(file.type || file.name);
                const fileSize = formatFileSize(file.size || 0);
                const uploadTime = file.uploaded ? formatTime(file.uploaded) : 'Recently';
                
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="${fileIcon.color} text-lg mr-3">
                            <i class="${fileIcon.icon}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-800 truncate max-w-[200px]">${file.name}</p>
                            <p class="text-xs text-gray-500">${fileSize}  Uploaded ${uploadTime}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800 view-file-btn" data-file="${file.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800 delete-file-btn" data-file="${file.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // Add event listeners for file buttons
            document.querySelectorAll('.view-file-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const fileId = this.dataset.file;
                    viewFile(fileId, reqId, dept);
                });
            });
            
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const fileId = this.dataset.file;
                    if (confirm('Are you sure you want to delete this file?')) {
                        deleteFile(fileId, reqId, dept);
                    }
                });
            });
        }

        // Handle file upload
        function handleFileUpload() {
            const files = Array.from(fileUpload.files);
            const reqId = appState.currentRequirementId;
            
            if (!reqId) return;
            
            // Initialize uploaded files array for this requirement if not exists
            if (!appState.uploadedFiles[reqId]) {
                appState.uploadedFiles[reqId] = [];
            }
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                    return;
                }
                
                const allowedTypes = ['application/pdf', 'application/msword', 
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'image/jpeg', 'image/png'];
                
                if (!allowedTypes.includes(file.type)) {
                    alert(`File ${file.name} has an unsupported format.`);
                    return;
                }
                
                // Create unique file ID
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Add to uploaded files
                appState.uploadedFiles[reqId].push({
                    id: fileId,
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploaded: new Date().toISOString()
                });
                
                // Add to file list display
                addFileToList(fileId, file.name, file.size, file.type);
            });
            
            // Reset file input
            fileUpload.value = '';
        }

        // Add file to list display
        function addFileToList(fileId, fileName, fileSize, fileType) {
            // Remove "no files" message if present
            const noFilesMsg = fileList.querySelector('.text-gray-500.italic');
            if (noFilesMsg) {
                noFilesMsg.remove();
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item bg-blue-50 p-3 rounded-lg flex items-center justify-between border border-blue-100';
            fileItem.dataset.fileId = fileId;
            
            const fileIcon = getFileIcon(fileType || fileName);
            const formattedSize = formatFileSize(fileSize);
            
            fileItem.innerHTML = `
                <div class="flex items-center">
                    <div class="${fileIcon.color} text-lg mr-3">
                        <i class="${fileIcon.icon}"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 truncate max-w-[200px]">${fileName}</p>
                        <p class="text-xs text-gray-500">${formattedSize}  Ready to upload</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="text-red-600 hover:text-red-800 remove-file-btn" data-file="${fileId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            fileList.appendChild(fileItem);
            
            // Add event listener for remove button
            fileItem.querySelector('.remove-file-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                removeUploadedFile(fileId);
            });
        }

        // Remove uploaded file from temporary storage
        function removeUploadedFile(fileId) {
            const reqId = appState.currentRequirementId;
            if (!reqId || !appState.uploadedFiles[reqId]) return;
            
            // Remove from array
            appState.uploadedFiles[reqId] = appState.uploadedFiles[reqId].filter(file => file.id !== fileId);
            
            // Remove from DOM
            const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileElement) {
                fileElement.remove();
            }
            
            // If no files left, show message
            if (fileList.children.length === 0) {
                fileList.innerHTML = '<div class="text-gray-500 italic text-sm text-center p-4">No files uploaded yet</div>';
            }
        }

        // View file
        function viewFile(fileId, reqId, dept) {
            // In a real app, this would open or download the file
            // For simulation, we'll just show an alert
            alert(`Viewing file: ${fileId}\n\nIn a real application, this would open or download the actual file.`);
        }

        // Delete file
        function deleteFile(fileId, reqId, dept) {
            // Remove from requirement files
            const requirement = dept.requirements.find(r => r.id === reqId);
            if (requirement && requirement.files) {
                requirement.files = requirement.files.filter(f => f.id !== fileId);
            }
            
            // Remove from file system
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            const reqFolderName = `Requirement_${reqId}`;
            
            if (appState.fileSystem.Shared?.Audit_Files?.[deptFolderName]?.[reqFolderName]?.[fileId]) {
                delete appState.fileSystem.Shared.Audit_Files[deptFolderName][reqFolderName][fileId];
                
                // Add activity log
                addActivity(`Deleted file from requirement #${reqId}`, dept.id);
                
                // Reload files
                const folderInfo = { deptFolder: deptFolderName, reqFolder: reqFolderName };
                loadExistingFiles(reqId, dept, folderInfo);
            }
        }

        // Save requirement status
        async function saveRequirementStatus(id, dept) {
            const requirement = dept.requirements.find(req => req.id === id);
            
            if (!requirement) return;
            
            try {
                // Get selected status
                let selectedStatus = 'pending';
                document.querySelectorAll('.status-btn').forEach(btn => {
                    if (btn.classList.contains('border-2')) {
                        selectedStatus = btn.dataset.status;
                    }
                });
                
                const remarks = document.getElementById('remarks').value;
                const receivingDate = document.getElementById('receiving-date').value || requirement.receivingDate;
                
                // Save to server API
                await apiClient.updateRequirement(dept.id, id, {
                    status: selectedStatus,
                    remarks,
                    receivingDate
                });
                
                // Update local requirement
                requirement.status = selectedStatus;
                requirement.remarks = remarks;
                requirement.receivingDate = receivingDate;
                
                // Update UI
                updateDirectorStats(dept);
                renderDirectorRequirements();
                
                // Show confirmation
                showToast('Status updated successfully!');
                
                // Close modal
                closeUpdateModal();
            } catch (error) {
                showToast(`Error updating status: ${error.message}`, 'error');
            }
        }

        // Submit requirement status
        async function submitRequirementStatus(id, dept) {
            const requirement = dept.requirements.find(req => req.id === id);
            
            if (!requirement) return;
            
            try {
                // Get selected status
                let selectedStatus = 'pending';
                document.querySelectorAll('.status-btn').forEach(btn => {
                    if (btn.classList.contains('border-2')) {
                        selectedStatus = btn.dataset.status;
                    }
                });
                
                // For submission, set to completed if not already
                if (selectedStatus !== 'completed') {
                    selectedStatus = 'completed';
                    
                    // Update status button UI
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.classList.remove('border-2', 'border-blue-500');
                        if (btn.dataset.status === 'completed') {
                            btn.classList.add('border-2', 'border-blue-500');
                        }
                    });
                }
                
                const remarks = document.getElementById('remarks').value;
                
                // Set receiving date to today if completed
                let receivingDate = requirement.receivingDate;
                if (selectedStatus === 'completed') {
                    const today = new Date();
                    receivingDate = today.toISOString().split('T')[0];
                    document.getElementById('receiving-date').value = receivingDate;
                }
                
                // Upload files first if any
                const uploadedFiles = appState.uploadedFiles[id] || [];
                if (uploadedFiles.length > 0) {
                    // Prepare files for upload
                    const filesToUpload = uploadedFiles.map(f => ({
                        name: f.name,
                        type: f.type,
                        size: f.size,
                        data: f.file // Store file object, will be handled by API
                    }));
                    
                    await apiClient.uploadFiles(dept.id, id, filesToUpload);
                }
                
                // Save requirement status
                await apiClient.updateRequirement(dept.id, id, {
                    status: selectedStatus,
                    remarks,
                    receivingDate
                });
                
                // Update local requirement
                requirement.status = selectedStatus;
                requirement.remarks = remarks;
                requirement.receivingDate = receivingDate;
                
                // Clear temporary files
                appState.uploadedFiles[id] = [];
                
                // Update UI
                updateDirectorStats(dept);
                renderDirectorRequirements();
                
                // Show confirmation
                showToast(`Requirement submitted with ${uploadedFiles.length} files!`);
                
                // Close modal
                closeUpdateModal();
            } catch (error) {
                showToast(`Error submitting requirement: ${error.message}`, 'error');
            }
        }

        // Save files to file system (DEPRECATED - use apiClient.uploadFiles instead)
        function saveFilesToFileSystem(reqId, dept, uploadedFiles) {
            // This function is deprecated. File uploads are now handled server-side via the API.
            // See apiClient.uploadFiles() for the new implementation.
        }

        // Submit all requirements
        function submitAllRequirements(dept) {
            const pendingReqs = dept.requirements.filter(req => req.status === 'pending');
            
            if (pendingReqs.length === 0) {
                alert('No pending requirements to submit!');
                return;
            }
            
            if (confirm(`Are you sure you want to submit all ${pendingReqs.length} pending requirements?`)) {
                const today = new Date().toISOString().split('T')[0];
                
                dept.requirements.forEach(req => {
                    if (req.status === 'pending') {
                        req.status = 'completed';
                        req.receivingDate = today;
                    }
                });
                
                // Add activity log
                addActivity(`Submitted all ${pendingReqs.length} pending requirements`, dept.id);
                
                // Update UI
                updateDirectorStats(dept);
                renderDirectorRequirements();
                
                showToast(`All ${pendingReqs.length} requirements submitted successfully!`);
            }
        }

        // Export department data
        function exportDepartmentData(dept) {
            let csvContent = "Sr. No.,Information Requested,Request Date,Status,Remarks\n";
            
            dept.requirements.forEach((req, index) => {
                csvContent += `${index + 1},"${req.description}","${formatDate(req.requestDate)}","${getStatusText(req.status)}","${req.remarks || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dept.name.replace(/\s+/g, '_')}_Audit_Requirements.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Add activity log
            addActivity('Exported department requirements data', dept.id);
            
            showToast('Data exported successfully!');
        }

        // Open user modal
        function openUserModal(userId = null) {
            appState.editingUserId = userId;
            
            if (userId) {
                // Edit mode
                document.getElementById('user-modal-title').textContent = 'Edit User';
                resetPasswordBtn.classList.remove('hidden');
                
                const user = appState.users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = '';
                    document.getElementById('user-fullname').value = user.fullName;
                    document.getElementById('user-email').value = user.email || '';
                    document.getElementById('user-role-select').value = user.role;
                    document.getElementById('user-department').value = user.department || '';
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('editing-user-id').value = userId;
                    
                    // Show/hide department based on role
                    const deptContainer = document.getElementById('department-select-container');
                    if (user.role === 'director') {
                        deptContainer.classList.remove('hidden');
                    } else {
                        deptContainer.classList.add('hidden');
                    }
                }
            } else {
                // Add mode
                document.getElementById('user-modal-title').textContent = 'Add New User';
                resetPasswordBtn.classList.add('hidden');
                document.getElementById('user-form').reset();
                document.getElementById('editing-user-id').value = '';
                document.getElementById('department-select-container').classList.add('hidden');
            }
            
            userModal.classList.remove('hidden');
        }

        // Save user
        async function saveUser() {
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;
            const fullName = document.getElementById('user-fullname').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const role = document.getElementById('user-role-select').value;
            const department = document.getElementById('user-department').value;
            const status = document.getElementById('user-status').value;
            const editingId = document.getElementById('editing-user-id').value;
            
            // Validation
            if (!username || !fullName || !role) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!editingId && !password) {
                alert('Please provide a password for new user');
                return;
            }
            
            if (role === 'director' && !department) {
                alert('Please select a department for director role');
                return;
            }
            
            try {
                const userData = {
                    username,
                    fullName,
                    email,
                    role,
                    department: role === 'director' ? parseInt(department) : null,
                    status
                };
                
                if (password) {
                    userData.password = password;
                }
                
                if (editingId) {
                    // Update existing user
                    await apiClient.updateUser(parseInt(editingId), userData);
                    showToast('User updated successfully!');
                } else {
                    // Add new user
                    await apiClient.createUser({ ...userData, password });
                    showToast('User added successfully!');
                }
                
                // Reload admin dashboard
                loadAdminStats();
                loadUsersTable();
                
                // Close modal
                closeUserModal();
            } catch (error) {
                showToast(`Error saving user: ${error.message}`, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (userId === 1) return;
            
            try {
                await apiClient.deleteUser(userId);
                
                // Reload admin dashboard
                loadAdminStats();
                loadUsersTable();
                
                showToast('User deleted successfully!');
            } catch (error) {
                showToast(`Error deleting user: ${error.message}`, 'error');
            }
            loadUsersTable();
            
            showToast('User deleted successfully!');
        }

        // Show change password modal
        function showChangePasswordModal() {
            changePasswordModal.classList.remove('hidden');
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            
            if (newPassword.length < 6) {
                errorDiv.querySelector('#password-error-message').textContent = 'New password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.querySelector('#password-error-message').textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Update password via API
                await apiClient.updateUser(appState.currentUser.id, { password: newPassword });
                
                // Update current user in state
                appState.currentUser.password = newPassword;
                
                showToast('Password changed successfully!');
                
                closePasswordModal();
                document.getElementById('change-password-form').reset();
                errorDiv.classList.add('hidden');
            } catch (error) {
                errorDiv.querySelector('#password-error-message').textContent = error.message || 'Error changing password';
                errorDiv.classList.remove('hidden');
            }
        }

        // Add activity log
        function addActivity(message, departmentId) {
            // Activity logging is now handled server-side
            // This function is kept for backward compatibility with existing code
            // The server automatically logs all activities through the API
        }

        // Toggle user menu
        function toggleUserMenu() {
            userMenu.classList.toggle('hidden');
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                appState.currentUser = null;
                localStorage.removeItem('currentUser');
                apiClient.logout();
                
                appContainer.classList.add('hidden');
                loginPage.classList.remove('hidden');
                
                loginForm.reset();
            }
        }

        // Close update modal
        function closeUpdateModal() {
            updateModal.classList.add('hidden');
            
            document.querySelectorAll('.status-btn').forEach(btn => btn.disabled = false);
            document.getElementById('receiving-date').disabled = false;
            document.getElementById('remarks').disabled = false;
            saveStatusBtn.classList.remove('hidden');
            submitStatusBtn.classList.remove('hidden');
        }

        // Close user modal
        function closeUserModal() {
            userModal.classList.add('hidden');
            document.getElementById('user-form').reset();
        }

        // Close password modal
        function closePasswordModal() {
            changePasswordModal.classList.add('hidden');
            document.getElementById('change-password-form').reset();
            document.getElementById('password-error').classList.add('hidden');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = confirmationToast;
            const toastMessage = toast.querySelector('p:first-child');
            toastMessage.textContent = message;
            
            // Update toast styling based on type
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else if (type === 'warning') {
                toast.classList.add('bg-yellow-600');
            } else {
                toast.classList.add('bg-green-600');
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Helper functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-pending';
                case 'in-progress': return 'status-in-progress';
                case 'completed': return 'status-completed';
                case 'overdue': return 'status-overdue';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                case 'overdue': return 'Overdue';
                default: return status;
            }
        }

        // Open folder configuration modal
        function openFolderConfigModal() {
            folderConfigList.innerHTML = '';
            
            appState.departments.forEach(dept => {
                const currentPath = appState.folderConfig[dept.id]?.path || '';
                const currentUrl = appState.folderConfig[dept.id]?.sharedUrl || '';
                
                const configItem = document.createElement('div');
                configItem.className = 'border border-gray-200 rounded-lg p-5 space-y-4';
                configItem.innerHTML = `
                    <div class="pb-3 border-b border-gray-100">
                        <h5 class="font-semibold text-gray-900 text-lg">${dept.name}</h5>
                        <p class="text-sm text-gray-500">Configure folder paths and shared URLs</p>
                    </div>
                    
                    <!-- Local Folder Path -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-folder mr-2 text-gray-600"></i>Local Folder Path
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                class="flex-1 folder-path-input border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                data-dept="${dept.id}" 
                                data-type="path"
                                placeholder="E.g., D:\\Shared\\Audit\\${dept.name.replace(/\\s+/g, '_')}" 
                                value="${currentPath}">
                            <button class="browse-folder-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium text-sm" data-dept="${dept.id}">
                                <i class="fas fa-folder mr-1"></i> Browse
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Local server path for storing uploaded files</p>
                    </div>
                    
                    <!-- Shared Folder URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-link mr-2 text-gray-600"></i>Shared Folder URL
                        </label>
                        <input 
                            type="text" 
                            class="w-full folder-url-input border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                            data-dept="${dept.id}" 
                            data-type="url"
                            placeholder="E.g., https://sharepoint.company.com/sites/audit/${dept.name.replace(/\\s+/g, '_')} or \\\\\\\\SERVER\\\\Audit\\\\${dept.name.replace(/\\s+/g, '_')}" 
                            value="${currentUrl}">
                        <p class="text-xs text-gray-500 mt-1">SharePoint, OneDrive, or network share URL where directors will upload files</p>
                    </div>
                `;
                
                folderConfigList.appendChild(configItem);
            });
            
            // Add event listeners for browse buttons
            document.querySelectorAll('.browse-folder-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    browseFolderPath(this.dataset.dept);
                });
            });
            
            folderConfigModal.classList.remove('hidden');
        }
        
        // Browse folder path (simulated)
        function browseFolderPath(deptId) {
            const input = document.querySelector(`input[data-dept="${deptId}"]`);
            
            // In a real application, this would open a file browser dialog
            // For now, we'll show a prompt with common paths
            const commonPaths = [
                'D:\\Shared\\Documents',
                'D:\\Shared\\Audit_Files',
                '\\\\\\\\SERVER\\\\Shared',
                'C:\\Users\\Public\\Documents'
            ];
            
            let path = prompt(
                `Select or enter the root shared folder path for this department.\\n\\nCommon paths:\\n${commonPaths.join('\\n')}\\n\\nEnter path:`,
                input.value || 'D:\\\\Shared\\\\AuditFiles'
            );
            
            if (path !== null) {
                input.value = path;
            }
        }
        
        // Save folder configuration
        async function saveFolderConfiguration() {
            const pathInputs = document.querySelectorAll('.folder-path-input');
            const urlInputs = document.querySelectorAll('.folder-url-input');
            
            try {
                // Save paths and URLs via API
                const updates = [];
                
                pathInputs.forEach(input => {
                    const deptId = parseInt(input.dataset.dept);
                    const path = input.value.trim();
                    const urlInput = document.querySelector(`.folder-url-input[data-dept="${deptId}"]`);
                    const sharedUrl = urlInput ? urlInput.value.trim() : '';
                    
                    updates.push(
                        apiClient.updateFolderConfig(deptId, { path, sharedUrl })
                    );
                });
                
                // Wait for all updates to complete
                await Promise.all(updates);
                
                // Reload folder config from server
                appState.folderConfig = await apiClient.getFolderConfig();
                
                // Close modal and reload table
                closeFolderConfigModal();
                loadFolderConfigTable();
                
                // Show confirmation
                showToast('Folder configuration saved successfully!');
            } catch (error) {
                showToast(`Error saving configuration: ${error.message}`, 'error');
            }
        }
        
        // Close folder configuration modal
        function closeFolderConfigModal() {
            folderConfigModal.classList.add('hidden');
        }

        // Initialize shared folder upload for directors
        function initializeSharedFolderUpload() {
            const uploadDropZone = document.getElementById('upload-drop-zone');
            const fileInput = document.getElementById('shared-folder-upload');
            
            if (!uploadDropZone || !fileInput) return;
            
            // Update folder info display
            updateSharedFolderInfo();
            
            // Load uploaded files list
            loadUploadedFilesForDirector();
            
            // Drag and drop events
            uploadDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            
            uploadDropZone.addEventListener('dragleave', () => {
                uploadDropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            uploadDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = e.dataTransfer.files;
                handleSharedFolderFileUpload(files);
            });
            
            // Click to upload
            uploadDropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                handleSharedFolderFileUpload(e.target.files);
            });
        }
        
        // Update shared folder info display for director
        function updateSharedFolderInfo() {
            const user = appState.currentUser;
            const folderPath = appState.folderConfig[user.department]?.path || '';
            const sharedUrl = appState.folderConfig[user.department]?.sharedUrl || '';
            
            const pathDisplay = document.getElementById('shared-folder-path-display');
            const urlDisplay = document.getElementById('shared-folder-url-display');
            
            if (pathDisplay) {
                pathDisplay.innerHTML = folderPath ? 
                    `<i class="fas fa-folder mr-2 text-gray-600"></i>${folderPath}` :
                    '<i class="fas fa-folder mr-2 text-gray-400"></i><span class="text-gray-400">Not configured</span>';
            }
            
            if (urlDisplay) {
                if (sharedUrl) {
                    urlDisplay.innerHTML = `<i class="fas fa-link mr-2 text-blue-600"></i><a href="${sharedUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 break-all">${sharedUrl}</a>`;
                } else {
                    urlDisplay.innerHTML = '<i class="fas fa-link mr-2 text-gray-400"></i><span class="text-gray-400">Not configured</span>';
                }
            }
        }
        
        // Handle shared folder file upload
        function handleSharedFolderFileUpload(files) {
            const user = appState.currentUser;
            if (!user || !user.department) return;
            
            const dept = appState.departments.find(d => d.id === user.department);
            if (!dept) return;
            
            // Initialize uploaded files structure if not exists
            if (!appState.uploadedFiles) {
                appState.uploadedFiles = {};
            }
            if (!appState.uploadedFiles[dept.id]) {
                appState.uploadedFiles[dept.id] = [];
            }
            
            let filesAdded = 0;
            
            for (let file of files) {
                // Validate file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`File "${file.name}" exceeds 10MB limit. Skipped.`, 'error');
                    continue;
                }
                
                // Validate file type
                const allowedExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'jpg', 'jpeg', 'png', 'gif', 'bmp'];
                const fileExt = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(fileExt)) {
                    showToast(`File type ".${fileExt}" not allowed.`, 'error');
                    continue;
                }
                
                // Create file record
                const fileRecord = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    uploadDate: new Date().toISOString(),
                    uploader: user.fullName,
                    uploaderId: user.id
                };
                
                appState.uploadedFiles[dept.id].push(fileRecord);
                filesAdded++;
            }
            
            if (filesAdded > 0) {
                // Reload files list
                loadUploadedFilesForDirector();
                
                // Show confirmation
                showToast(`${filesAdded} file${filesAdded !== 1 ? 's' : ''} uploaded successfully!`);
                
                // Add activity log
                addActivity(`Uploaded ${filesAdded} file(s) to shared folder`, user.department);
            }
            
            // Clear file input
            document.getElementById('shared-folder-upload').value = '';
        }
        
        // Load uploaded files for director
        function loadUploadedFilesForDirector() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            const uploadedFilesList = document.getElementById('uploaded-files-list');
            
            if (!uploadedFilesList || !dept) return;
            
            const files = appState.uploadedFiles?.[dept.id] || [];
            
            if (files.length === 0) {
                uploadedFilesList.innerHTML = '<p class="text-gray-500 italic text-sm">No files uploaded yet</p>';
                return;
            }
            
            uploadedFilesList.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition';
                
                // Get file icon
                const fileExt = file.name.split('.').pop().toLowerCase();
                let fileIcon = 'fas fa-file';
                if (['pdf'].includes(fileExt)) fileIcon = 'fas fa-file-pdf text-red-600';
                else if (['doc', 'docx'].includes(fileExt)) fileIcon = 'fas fa-file-word text-blue-600';
                else if (['xls', 'xlsx'].includes(fileExt)) fileIcon = 'fas fa-file-excel text-green-600';
                else if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(fileExt)) fileIcon = 'fas fa-image text-purple-600';
                
                fileItem.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <i class="${fileIcon} mr-3 text-xl"></i>
                        <div class="flex-grow">
                            <p class="font-medium text-gray-800 text-sm">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(file.size)}  ${formatDate(file.uploadDate)}</p>
                        </div>
                    </div>
                    <button class="delete-file-btn text-red-600 hover:text-red-800 text-sm" data-file-id="${file.id}" data-dept="${dept.id}">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                `;
                
                uploadedFilesList.appendChild(fileItem);
            });
            
            // Add delete listeners
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fileId = this.dataset.fileId;
                    const deptId = this.dataset.dept;
                    deleteUploadedFile(fileId, deptId);
                });
            });
        }
        
        // Delete uploaded file
        function deleteUploadedFile(fileId, deptId) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            if (appState.uploadedFiles && appState.uploadedFiles[deptId]) {
                const index = appState.uploadedFiles[deptId].findIndex(f => f.id == fileId);
                if (index !== -1) {
                    const fileName = appState.uploadedFiles[deptId][index].name;
                    appState.uploadedFiles[deptId].splice(index, 1);
                    loadUploadedFilesForDirector();
                    loadUploadedFilesForAdmin();
                    showToast(`File "${fileName}" deleted successfully`);
                    addActivity(`Deleted file "${fileName}" from shared folder`, deptId);
                }
            }
        }
        
        // Load uploaded files for admin
        function loadUploadedFilesForAdmin() {
            const table = document.getElementById('admin-uploaded-files-table');
            if (!table) return;
            
            const filterValue = document.getElementById('admin-files-dept-filter')?.value || 'all';
            const allFiles = [];
            
            // Collect all files from all departments
            appState.departments.forEach(dept => {
                const deptFiles = appState.uploadedFiles?.[dept.id] || [];
                deptFiles.forEach(file => {
                    allFiles.push({
                        ...file,
                        department: dept.name,
                        departmentId: dept.id
                    });
                });
            });
            
            // Filter by department
            let filteredFiles = allFiles;
            if (filterValue !== 'all') {
                filteredFiles = allFiles.filter(f => f.departmentId === filterValue);
            }
            
            // Sort by upload date (newest first)
            filteredFiles.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
            
            if (filteredFiles.length === 0) {
                table.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 text-sm">No files uploaded</td></tr>`;
                return;
            }
            
            table.innerHTML = '';
            
            filteredFiles.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${file.department}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        <div class="flex items-center">
                            <i class="fas fa-file mr-2 text-gray-600"></i>
                            ${file.name}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatFileSize(file.size)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(file.uploadDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${file.uploader}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-red-600 hover:text-red-800 admin-delete-file-btn" data-file-id="${file.id}" data-dept="${file.departmentId}">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </td>
                `;
                
                table.appendChild(row);
            });
            
            // Add delete listeners
            document.querySelectorAll('.admin-delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteUploadedFile(this.dataset.fileId, this.dataset.dept);
                });
            });
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Show My Folder (Director)
        function showMyFolder() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            
            if (!dept) return;
            
            // Update modal title
            document.getElementById('folder-modal-title').textContent = `My Folder - ${dept.name}`;
            document.getElementById('dept-folder-name').textContent = dept.name;
            
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            const folderPath = `/Shared/Audit_Files/${deptFolderName}/`;
            document.getElementById('dept-folder-path').textContent = `Path: ${folderPath}`;
            
            // Load folder contents
            loadFolderContents(deptFolderName);
            
            folderModal.classList.remove('hidden');
        }

        // Show Shared Folder (Admin)
        function showSharedFolder() {
            // Update folder stats
            updateSharedFolderStats();
            
            // Load shared folder contents
            loadSharedFolderContents();
            
            sharedFolderModal.classList.remove('hidden');
        }

        // Load folder contents
        function loadFolderContents(deptFolderName) {
            const folderContents = document.getElementById('folder-contents');
            
            // Check if folder exists
            if (!appState.fileSystem.Shared?.Audit_Files?.[deptFolderName]) {
                folderContents.innerHTML = `
                    <div class="text-center text-gray-500 p-8">
                        <i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-lg">Folder is empty</p>
                        <p class="text-sm mt-2">No files or subfolders yet</p>
                    </div>
                `;
                return;
            }
            
            const folder = appState.fileSystem.Shared.Audit_Files[deptFolderName];
            let html = '<div class="folder-structure">';
            
            // Add requirement folders
            Object.keys(folder).forEach(key => {
                if (key === '_metadata') return;
                
                const subfolder = folder[key];
                const reqId = key.replace('Requirement_', '');
                const requirement = appState.departments
                    .find(d => d.name.replace(/[^a-zA-Z0-9]/g, '_') === deptFolderName)
                    ?.requirements.find(r => r.id === parseInt(reqId));
                
                html += `
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-folder folder-icon mr-2"></i>
                            <span class="font-medium">${key}</span>
                            <span class="text-xs text-gray-500 ml-2">${requirement ? requirement.description.substring(0, 50) + '...' : ''}</span>
                        </div>
                        <div class="folder-structure ml-4">
                `;
                
                // Add files in this requirement folder
                const fileKeys = Object.keys(subfolder).filter(k => k !== '_metadata');
                if (fileKeys.length === 0) {
                    html += `<div class="text-gray-400 text-sm italic">No files</div>`;
                } else {
                    fileKeys.forEach(fileKey => {
                        const file = subfolder[fileKey];
                        const fileIcon = getFileIcon(file.type);
                        html += `
                            <div class="file-item flex items-center p-2 rounded hover:bg-gray-50 mb-1">
                                <div class="${fileIcon.color} mr-2">
                                    <i class="${fileIcon.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">${file.name}</div>
                                    <div class="text-xs text-gray-500">${formatFileSize(file.size)}  ${formatDate(file.uploaded)}</div>
                                </div>
                                <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="downloadSimulatedFile('${file.id}', '${deptFolderName}', '${key}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        `;
                    });
                }
                
                html += `</div></div>`;
            });
            
            html += '</div>';
            
            if (Object.keys(folder).filter(k => k !== '_metadata').length === 0) {
                folderContents.innerHTML = `
                    <div class="text-center text-gray-500 p-8">
                        <i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-lg">No requirement folders yet</p>
                        <p class="text-sm mt-2">Upload files when updating requirements to create folders</p>
                    </div>
                `;
            } else {
                folderContents.innerHTML = html;
            }
        }

        // Load shared folder contents
        function loadSharedFolderContents() {
            const sharedContents = document.getElementById('shared-folder-contents');
            
            if (!appState.fileSystem.Shared?.Audit_Files) {
                sharedContents.innerHTML = `
                    <div class="text-center text-gray-500 p-8">
                        <i class="fas fa-server text-4xl text-gray-300 mb-3"></i>
                        <p class="text-lg">Shared folder is empty</p>
                    </div>
                `;
                return;
            }
            
            const auditFiles = appState.fileSystem.Shared.Audit_Files;
            let html = '<div class="space-y-4">';
            
            Object.keys(auditFiles).forEach(deptFolder => {
                if (deptFolder === '_metadata') return;
                
                const deptFiles = auditFiles[deptFolder];
                const deptName = deptFolder.replace(/_/g, ' ');
                const reqFolders = Object.keys(deptFiles).filter(k => k !== '_metadata');
                
                html += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-folder-open text-xl folder-icon mr-3"></i>
                            <div class="flex-1">
                                <h6 class="font-medium text-gray-800">${deptName}</h6>
                                <p class="text-xs text-gray-500">${reqFolders.length} requirement folder${reqFolders.length !== 1 ? 's' : ''}</p>
                            </div>
                            <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="expandFolder('${deptFolder}')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div id="folder-${deptFolder}" class="hidden pl-8">
                `;
                
                if (reqFolders.length === 0) {
                    html += `<div class="text-gray-400 text-sm italic p-2">No requirement folders</div>`;
                } else {
                    reqFolders.forEach(reqFolder => {
                        const files = Object.keys(deptFiles[reqFolder]).filter(k => k !== '_metadata');
                        html += `
                            <div class="mb-3">
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-folder text-sm folder-icon mr-2"></i>
                                    <span class="text-sm font-medium">${reqFolder}</span>
                                    <span class="text-xs text-gray-500 ml-2">${files.length} file${files.length !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="pl-6 space-y-1">
                        `;
                        
                        if (files.length === 0) {
                            html += `<div class="text-gray-400 text-xs italic">No files</div>`;
                        } else {
                            files.forEach(fileKey => {
                                const file = deptFiles[reqFolder][fileKey];
                                const fileIcon = getFileIcon(file.type);
                                html += `
                                    <div class="flex items-center text-xs">
                                        <div class="${fileIcon.color} mr-2">
                                            <i class="${fileIcon.icon}"></i>
                                        </div>
                                        <span class="truncate flex-1">${file.name}</span>
                                        <span class="text-gray-500 ml-2">${formatFileSize(file.size)}</span>
                                    </div>
                                `;
                            });
                        }
                        
                        html += `</div></div>`;
                    });
                }
                
                html += `</div></div>`;
            });
            
            html += '</div>';
            sharedContents.innerHTML = html;
            
            // Load recent uploads
            loadRecentUploads();
        }

        // Expand folder in shared view
        window.expandFolder = function(deptFolder) {
            const folderDiv = document.getElementById(`folder-${deptFolder}`);
            const button = folderDiv.previousElementSibling.querySelector('button');
            
            if (folderDiv.classList.contains('hidden')) {
                folderDiv.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-chevron-up"></i>';
            } else {
                folderDiv.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
        }

        // Update shared folder statistics
        function updateSharedFolderStats() {
            let totalDepts = 0;
            let totalFiles = 0;
            let totalSize = 0;
            
            if (appState.fileSystem.Shared?.Audit_Files) {
                const auditFiles = appState.fileSystem.Shared.Audit_Files;
                totalDepts = Object.keys(auditFiles).filter(k => k !== '_metadata').length;
                
                Object.keys(auditFiles).forEach(deptFolder => {
                    if (deptFolder === '_metadata') return;
                    
                    Object.keys(auditFiles[deptFolder]).forEach(reqFolder => {
                        if (reqFolder === '_metadata') return;
                        
                        Object.keys(auditFiles[deptFolder][reqFolder]).forEach(fileKey => {
                            if (fileKey === '_metadata') return;
                            
                            totalFiles++;
                            totalSize += auditFiles[deptFolder][reqFolder][fileKey].size || 0;
                        });
                    });
                });
            }
            
            document.getElementById('total-dept-folders').textContent = totalDepts;
            document.getElementById('total-shared-files').textContent = totalFiles;
            document.getElementById('total-shared-size').textContent = formatFileSize(totalSize);
            document.getElementById('shared-folder-size').textContent = formatFileSize(totalSize);
            document.getElementById('shared-folder-updated').textContent = 'Just now';
        }

        // Load recent uploads
        function loadRecentUploads() {
            const recentUploadsList = document.getElementById('recent-uploads-list');
            recentUploadsList.innerHTML = '';
            
            // Collect all files with upload timestamps
            let allFiles = [];
            
            if (appState.fileSystem.Shared?.Audit_Files) {
                const auditFiles = appState.fileSystem.Shared.Audit_Files;
                
                Object.keys(auditFiles).forEach(deptFolder => {
                    if (deptFolder === '_metadata') return;
                    
                    Object.keys(auditFiles[deptFolder]).forEach(reqFolder => {
                        if (reqFolder === '_metadata') return;
                        
                        Object.keys(auditFiles[deptFolder][reqFolder]).forEach(fileKey => {
                            if (fileKey === '_metadata') return;
                            
                            const file = auditFiles[deptFolder][reqFolder][fileKey];
                            allFiles.push({
                                ...file,
                                deptFolder: deptFolder,
                                reqFolder: reqFolder
                            });
                        });
                    });
                });
            }
            
            // Sort by upload time (newest first)
            allFiles.sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded));
            
            // Take top 5
            const recentFiles = allFiles.slice(0, 5);
            
            if (recentFiles.length === 0) {
                recentUploadsList.innerHTML = '<div class="text-sm text-gray-500 italic">No recent uploads</div>';
                return;
            }
            
            recentFiles.forEach(file => {
                const fileIcon = getFileIcon(file.type);
                const deptName = file.deptFolder.replace(/_/g, ' ');
                
                const item = document.createElement('div');
                item.className = 'flex items-center';
                item.innerHTML = `
                    <div class="${fileIcon.color} mr-2">
                        <i class="${fileIcon.icon} text-xs"></i>
                    </div>
                    <div class="flex-1 truncate">
                        <div class="text-xs font-medium truncate">${file.name}</div>
                        <div class="text-xs text-gray-500">${deptName}</div>
                    </div>
                `;
                recentUploadsList.appendChild(item);
            });
        }

        // Refresh My Folder
        function refreshMyFolder() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            
            if (!dept) return;
            
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            loadFolderContents(deptFolderName);
            
            showToast('Folder refreshed');
        }

        // Refresh Shared Folder
        function refreshSharedFolder() {
            loadSharedFolderContents();
            updateSharedFolderStats();
            showToast('Shared folder refreshed');
        }

        // Download My Folder
        function downloadMyFolder() {
            const user = appState.currentUser;
            const dept = appState.departments.find(d => d.id === user.department);
            
            if (!dept) return;
            
            // Create a zip of folder structure (simulated)
            const deptFolderName = dept.name.replace(/[^a-zA-Z0-9]/g, '_');
            const folder = appState.fileSystem.Shared?.Audit_Files?.[deptFolderName];
            
            if (!folder || Object.keys(folder).filter(k => k !== '_metadata').length === 0) {
                alert('No files to download');
                return;
            }
            
            // In a real application, this would create an actual zip file
            // For simulation, we'll create a text file with folder structure
            let folderStructure = `${dept.name} - Audit Files\n`;
            folderStructure += `Generated on: ${new Date().toLocaleString()}\n`;
            folderStructure += '='.repeat(50) + '\n\n';
            
            Object.keys(folder).forEach(reqFolder => {
                if (reqFolder === '_metadata') return;
                
                folderStructure += `${reqFolder}/\n`;
                
                const files = Object.keys(folder[reqFolder]).filter(k => k !== '_metadata');
                files.forEach(fileKey => {
                    const file = folder[reqFolder][fileKey];
                    folderStructure += `   ${file.name} (${formatFileSize(file.size)})\n`;
                });
                
                folderStructure += '\n';
            });
            
            // Create download link
            const blob = new Blob([folderStructure], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${deptFolderName}_folder_structure.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Folder structure downloaded');
        }

        // Download simulated file
        window.downloadSimulatedFile = function(fileId, deptFolder, reqFolder) {
            const file = appState.fileSystem.Shared?.Audit_Files?.[deptFolder]?.[reqFolder]?.[fileId];
            
            if (!file) {
                alert('File not found');
                return;
            }
            
            // In a real application, this would download the actual file
            // For simulation, we'll create a text file with file info
            const fileContent = `This is a simulated file for: ${file.name}\n\n`;
            const fileContent2 = `File Type: ${file.type}\n`;
            const fileContent3 = `File Size: ${formatFileSize(file.size)}\n`;
            const fileContent4 = `Uploaded: ${new Date(file.uploaded).toLocaleString()}\n`;
            const fileContent5 = `Department: ${deptFolder.replace(/_/g, ' ')}\n`;
            const fileContent6 = `Requirement: ${reqFolder}\n\n`;
            const fileContent7 = `In a real application, this would contain the actual file content.`;
            
            const content = fileContent + fileContent2 + fileContent3 + fileContent4 + fileContent5 + fileContent6 + fileContent7;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `simulated_${file.name}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('File downloaded (simulated)');
        }

        // Open view modal
        function openViewModal(id) {
            // Similar to openUpdateModal but in read-only mode
            openUpdateModal(id);
            document.getElementById('modal-title').textContent = 'View Requirement Details';
            
            // Disable editing
            document.querySelectorAll('.status-btn').forEach(btn => btn.disabled = true);
            document.getElementById('receiving-date').disabled = true;
            document.getElementById('remarks').disabled = true;
            saveStatusBtn.classList.add('hidden');
            submitStatusBtn.classList.add('hidden');
            
            // Hide file upload
            document.getElementById('file-upload').disabled = true;
            document.querySelector('label[for="file-upload"]').style.opacity = '0.5';
            document.querySelector('label[for="file-upload"]').style.pointerEvents = 'none';
        }

        // Helper function to get file icon
        function getFileIcon(fileTypeOrName) {
            const name = fileTypeOrName.toLowerCase();
            
            if (name.includes('pdf')) {
                return { icon: 'fas fa-file-pdf', color: 'pdf-icon' };
            } else if (name.includes('word') || name.includes('doc')) {
                return { icon: 'fas fa-file-word', color: 'doc-icon' };
            } else if (name.includes('excel') || name.includes('xls')) {
                return { icon: 'fas fa-file-excel', color: 'excel-icon' };
            } else if (name.includes('image') || name.includes('jpg') || name.includes('jpeg') || name.includes('png')) {
                return { icon: 'fas fa-file-image', color: 'image-icon' };
            } else if (name.includes('folder')) {
                return { icon: 'fas fa-folder', color: 'folder-icon' };
            } else {
                return { icon: 'fas fa-file', color: 'text-gray-500' };
            }
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Close folder modal
        function closeFolderModal() {
            folderModal.classList.add('hidden');
        }

        // Close shared folder modal
        function closeSharedFolderModal() {
            sharedFolderModal.classList.add('hidden');
        }

    </script>
</body>
</html>
